---
phase: 03-code-audit
plan: 02
type: execute
---

<objective>
Analyze responsibility distribution across the AMS codebase to identify scattered logic, consolidation opportunities, and over-abstraction patterns.

Purpose: Map where responsibilities are fragmented or unnecessarily abstracted, enabling targeted refactoring in Phase 4.
Output: RESPONSIBILITY-MAP.md with subsystem boundaries, scatter analysis, and over-abstraction catalogue.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase 1 artifacts:**
@.planning/phases/01-discovery/FILE-INVENTORY.md
@.planning/phases/01-discovery/CALLGRAPH-INSIGHTS.md
@.planning/phases/01-discovery/MODULE-DEPS-DIAGRAM.md
@.planning/phases/01-discovery/DISCOVERY-SYNTHESIS.md

**Phase 2 artifacts:**
@.planning/phases/02-pipeline-analysis/PIPELINE-FLOW.md
@.planning/phases/02-pipeline-analysis/DATA-FLOW.md

**Previous plan in this phase:**
@.planning/phases/03-code-audit/03-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Ams.Core has 96 files (66% of codebase) - monolith concern
- 14+ NuGet packages in Core - mixed concerns
- Clean 3-layer architecture at project level, but internal organization unclear
- Pipeline has 7 stages with clear data flow (from Phase 2)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core subsystem mapping</name>
  <files>.planning/phases/03-code-audit/CORE-SUBSYSTEMS.md</files>
  <action>
Categorize the 96 Ams.Core files into logical subsystems:

**Expected subsystems (validate/adjust based on actual code):**
1. **Pipeline Orchestration** - PipelineService, stage coordination
2. **ASR Integration** - Nemo client, Whisper adapter, ASR models
3. **Alignment Engine** - Anchor computation, transcript alignment, DTW
4. **MFA Integration** - MfaWorkflow, TextGrid parsing, G2P
5. **Audio Processing** - FFmpeg wrappers, filters, decoding
6. **Book/Document** - Parsing, indexing, section detection
7. **Runtime/Context** - Book/Chapter/Workspace management
8. **Infrastructure** - Logging, configuration, utilities

For each file:
- Assign primary subsystem
- Note if file spans multiple concerns (smell)
- Identify subsystem dependencies

Output format:
```markdown
# Ams.Core Subsystem Map

## Subsystem Overview
| Subsystem | File Count | Key Classes | External Dependencies |
|-----------|------------|-------------|----------------------|

## File-to-Subsystem Assignment

### Pipeline Orchestration (X files)
| File | Primary Class | Notes |
|------|--------------|-------|

### ASR Integration (X files)
...

## Cross-Cutting Concerns
| File | Subsystems Touched | Why Cross-Cutting |
|------|-------------------|-------------------|

## Subsystem Dependency Graph
[Mermaid diagram showing which subsystems depend on which]
```
  </action>
  <verify>CORE-SUBSYSTEMS.md exists; all 96 Core files assigned to a subsystem; dependency graph included</verify>
  <done>Every Core file categorized; subsystem boundaries defined; cross-cutting concerns identified</done>
</task>

<task type="auto">
  <name>Task 2: Scattered responsibility identification</name>
  <files>.planning/phases/03-code-audit/SCATTERED-LOGIC.md</files>
  <action>
Identify logic that is fragmented across multiple files when it should be consolidated:

**Patterns to look for:**

1. **Same concept, multiple implementations:**
   - Multiple ways to do the same thing (e.g., two JSON serializers)
   - Duplicated validation logic
   - Copy-pasted utility methods

2. **Broken abstractions:**
   - Service that calls into implementation details it shouldn't know about
   - Model classes with business logic that should be in services
   - Utilities that have grown into pseudo-services

3. **Feature fragmentation:**
   - Feature logic split across unrelated files
   - Pipeline stage logic leaking into orchestration
   - Domain logic in CLI commands

4. **Cohesion violations:**
   - Classes doing too many unrelated things
   - Files that are "grab bags" of utilities
   - Services with methods that don't belong together

For each scattered responsibility found:
- Identify the files involved
- Describe what's scattered
- Propose consolidation target

Output format:
```markdown
# Scattered Responsibility Analysis

## Summary
- Scattered patterns found: X
- Files affected: Y
- Consolidation opportunities: Z

## Scattered Patterns

### Pattern 1: [Name]
**Files involved:** [list]
**What's scattered:** [description]
**Impact:** [why this matters]
**Consolidation target:** [where this logic should live]

### Pattern 2: [Name]
...

## Consolidation Recommendations
| Pattern | Current Location(s) | Target Location | Effort |
|---------|--------------------|-----------------| -------|
```
  </action>
  <verify>SCATTERED-LOGIC.md exists; at least 3 scattered patterns identified with consolidation recommendations</verify>
  <done>Scattered responsibilities documented with specific consolidation proposals</done>
</task>

<task type="auto">
  <name>Task 3: Over-abstraction audit</name>
  <files>.planning/phases/03-code-audit/RESPONSIBILITY-MAP.md</files>
  <action>
Identify abstractions that obscure rather than clarify:

**Over-abstraction patterns:**

1. **Interface with single implementation:**
   - IFooService with only FooService implementation
   - No test mocks or alternate implementations
   - Interface adds indirection without value

2. **Unnecessary wrapper layers:**
   - Class that just delegates to another class
   - "Manager" or "Handler" that does nothing
   - Adapter patterns with no adaptation

3. **Premature generalization:**
   - Generic<T> used with only one T
   - Abstract base class with single derived class
   - Strategy pattern with one strategy

4. **Ceremony over substance:**
   - Factory that always creates the same thing
   - Builder with no customization options
   - Options class with only defaults used

For each over-abstraction:
- Identify the abstraction
- Count its implementations/usages
- Assess: Keep, Simplify, or Remove

Synthesize all Task 1-3 findings into RESPONSIBILITY-MAP.md:

Output format:
```markdown
# AMS Responsibility Map

## Executive Summary
- Subsystems identified: X
- Scattered patterns: Y
- Over-abstractions: Z
- Refactoring priority items: N

## Subsystem Architecture
[Summary from CORE-SUBSYSTEMS.md with key insights]

## Responsibility Issues

### Scattered Logic (from SCATTERED-LOGIC.md)
[Top 5 most impactful scattered patterns]

### Over-Abstraction Catalogue
| Abstraction | Type | Implementations | Verdict | Action |
|-------------|------|-----------------|---------|--------|

## Recommended Consolidations
[Prioritized list of consolidation opportunities]

## Architecture Health Score
- Cohesion: X/10
- Coupling: X/10
- Abstraction appropriateness: X/10
- Overall: X/10

## Phase 4 Inputs
[Key items to address in Recommendations phase]
```
  </action>
  <verify>RESPONSIBILITY-MAP.md exists with executive summary, over-abstraction catalogue, and health scores</verify>
  <done>Complete responsibility map with subsystems, scattered logic, over-abstractions, and health assessment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CORE-SUBSYSTEMS.md exists with all 96 Core files categorized
- [ ] SCATTERED-LOGIC.md exists with consolidation recommendations
- [ ] RESPONSIBILITY-MAP.md exists with executive summary and health scores
- [ ] Subsystem dependency graph created (Mermaid)
- [ ] Over-abstraction catalogue has verdict for each item
</verification>

<success_criteria>
- All 96 Core files assigned to subsystems
- At least 3 scattered responsibility patterns identified
- Over-abstractions catalogued with actionable verdicts
- Architecture health score calculated
- Phase 4 inputs clearly identified
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-audit/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Responsibility Analysis Summary

**[One-liner: e.g., "Mapped 8 subsystems in Core; identified X scattered patterns and Y over-abstractions"]**

## Accomplishments
- [Key findings]

## Files Created
- `CORE-SUBSYSTEMS.md` - Subsystem categorization
- `SCATTERED-LOGIC.md` - Scattered responsibility analysis
- `RESPONSIBILITY-MAP.md` - Consolidated responsibility map

## Key Findings
- [Most significant responsibility issues]

## Next Step
Ready for 03-03-PLAN.md (Project Audit & Synthesis)
</output>
