---
phase: 07-service-decomposition
plan: 05
type: execute
---

<objective>
Standardize Prosody patterns and improve test coverage for new services.

Purpose: Complete Phase 7 by standardizing Prosody subsystem and adding tests for new utilities.
Output: Consistent Prosody patterns, tests for ChapterLabelResolver, AsrAudioPreparer, and new alignment services.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- AUD-031: Prosody patterns need standardization
- Phase 6 created ChapterLabelResolver and AsrAudioPreparer utilities (need tests)
- Phase 7 plans 01-03 created new alignment services (need tests)

**Issues being addressed:**
- AUD-031: Prosody patterns inconsistent - STANDARDIZE
- Inferred: Test coverage for new utilities and services

**Prosody files (9 total):**
- `Prosody/PauseAdjustmentsDocument.cs`
- `Prosody/PauseAnalysisReport.cs`
- `Prosody/PauseCompressionMath.cs`
- `Prosody/PauseDynamicsService.cs`
- `Prosody/PauseMapBuilder.cs`
- `Prosody/PauseMapModels.cs`
- `Prosody/PauseModels.cs`
- `Prosody/PausePolicyStorage.cs`
- `Prosody/PauseTimelineApplier.cs`

**Utilities needing tests (from Phase 6):**
@host/Ams.Core/Common/ChapterLabelResolver.cs
@host/Ams.Core/Audio/AsrAudioPreparer.cs

**Relevant source files:**
@host/Ams.Core/Prosody/
@host/Ams.Tests/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review and standardize Prosody naming conventions</name>
  <files>host/Ams.Core/Prosody/*.cs</files>
  <action>
Review Prosody subsystem for consistency and apply standardizations:

1. Audit current patterns in all 9 files:
- Check naming conventions (PascalCase, consistent prefixes)
- Check model patterns (records vs classes, immutability)
- Check method signatures (async patterns, cancellation token usage)
- Check documentation (XML comments on public members)

2. Apply standardizations as needed:

a) Naming consistency:
- All public types should follow C# conventions
- Method names should be verb-first (ComputeX, BuildY, ApplyZ)
- Parameter names should be camelCase

b) Model patterns:
- Prefer records for immutable data transfer objects
- Use init-only properties for configuration objects
- Consistent use of required vs optional parameters

c) Service patterns:
- Consistent constructor injection patterns
- Consistent logging patterns (static Logger field)
- Consistent async method signatures with CancellationToken

3. Add XML documentation to public members if missing:
- Brief summary for each public type
- Parameter descriptions for public methods
- Return value descriptions

Note: Keep changes minimal and focused on consistency. Don't refactor working code unnecessarily.
  </action>
  <verify>
- `dotnet build host/Ams.Core` succeeds
- No breaking changes to Prosody API
- Consistent patterns across all 9 Prosody files
  </verify>
  <done>
- Prosody naming conventions standardized
- Model patterns consistent
- XML documentation added to public members
- Build succeeds
- AUD-031 RESOLVED
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for new utilities and services</name>
  <files>host/Ams.Tests/Common/ChapterLabelResolverTests.cs, host/Ams.Tests/Audio/AsrAudioPreparerTests.cs, host/Ams.Tests/Services/Alignment/AnchorComputeServiceTests.cs</files>
  <action>
Add unit tests for utilities created in Phase 6 and services created in Phase 7:

1. Create `ChapterLabelResolverTests.cs`:
```csharp
// Test TryExtractChapterNumber with various inputs
// - "Chapter 1" -> 1
// - "CHAPTER 10" -> 10
// - "Section 5" -> 5
// - "Introduction" -> null
// Test EnumerateLabelCandidates
// - Verify generates expected candidate patterns
// Test ResolveSection (if public)
```

2. Create `AsrAudioPreparerTests.cs`:
```csharp
// Test BuildMonoPanClause with different channel counts
// - 1 channel -> identity or null
// - 2 channels -> stereo pan formula
// - 6 channels -> 5.1 surround pan formula
// Test DownmixToMonoSimple with mock audio buffer
// - Verify averaging behavior for stereo input
```

3. Create `AnchorComputeServiceTests.cs` (basic smoke tests):
```csharp
// Test ComputeAnchorsAsync returns valid AnchorDocument
// Test BuildPolicy returns correctly configured AnchorPolicy
// Test with null options uses defaults
```

4. Run all tests to verify:
- New tests pass
- Existing tests still pass
- Coverage improved for new code paths

Focus on testing public API contracts, not internal implementation details.
  </action>
  <verify>
- `dotnet build host/Ams.Tests` succeeds
- `dotnet test host/Ams.Tests` passes all tests (should be >60 now)
- New test files created and contain meaningful tests
  </verify>
  <done>
- ChapterLabelResolverTests.cs created with TryExtractChapterNumber tests
- AsrAudioPreparerTests.cs created with BuildMonoPanClause tests
- AnchorComputeServiceTests.cs created with basic smoke tests
- All tests pass (target: 65+ tests)
- Phase 7 complete
- v1.1 milestone complete (health 6.8 -> 8.0)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds for all projects
- [ ] `dotnet test host/Ams.Tests` passes all tests
- [ ] Prosody files have consistent patterns
- [ ] New test files created for utilities and services
- [ ] Test count increased (was 60, target 65+)
</verification>

<success_criteria>
- Prosody subsystem standardized (AUD-031)
- ChapterLabelResolver has unit tests
- AsrAudioPreparer has unit tests
- AnchorComputeService has basic tests
- All tests pass
- Phase 7 complete
- v1.1 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-service-decomposition/07-05-SUMMARY.md`

This is the final plan in Phase 7. After completion:
- Update STATE.md to mark Phase 7 complete
- Update ROADMAP.md progress table
- v1.1 milestone should be complete
- Health score target: 8.0/10 achieved
</output>
