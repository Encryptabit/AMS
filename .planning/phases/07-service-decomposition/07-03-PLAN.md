---
phase: 07-service-decomposition
plan: 03
type: execute
---

<objective>
Extract TranscriptHydrationService and complete AlignmentService facade.

Purpose: Complete AlignmentService decomposition with hydration service and DI registration.
Output: New TranscriptHydrationService, lean AlignmentService facade, all services registered in DI.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-service-decomposition/07-01-SUMMARY.md
@.planning/phases/07-service-decomposition/07-02-SUMMARY.md

**Prior decisions affecting this phase:**
- AUD-003: AlignmentService decomposition in progress
- 07-01 completed: AnchorComputeService extracted
- 07-02 completed: TranscriptIndexService extracted

**Issues being addressed:**
- AUD-003: AlignmentService god class decomposition (final step)

**Current state after 07-02:**
- AlignmentService should contain only HydrateTranscriptAsync and its helpers (~150 lines)
- Methods remaining: HydrateTranscriptAsync, BuildHydratedTranscript, BuildParagraphScript, RequireBookAndAsr

**Relevant source files:**
@host/Ams.Core/Services/Alignment/AlignmentService.cs
@host/Ams.Core/Services/Alignment/AnchorComputeService.cs
@host/Ams.Core/Services/Alignment/TranscriptIndexService.cs
@host/Ams.Cli/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TranscriptHydrationService</name>
  <files>host/Ams.Core/Services/Alignment/ITranscriptHydrationService.cs, host/Ams.Core/Services/Alignment/TranscriptHydrationService.cs</files>
  <action>
Create new focused service for transcript hydration:

1. Create `ITranscriptHydrationService.cs`:
```csharp
public interface ITranscriptHydrationService
{
    Task<HydratedTranscript> HydrateTranscriptAsync(
        ChapterContext context,
        HydrationOptions? options = null,
        CancellationToken cancellationToken = default);
}
```

2. Create `TranscriptHydrationService.cs`:
- No external dependencies needed
- Copy `HydrateTranscriptAsync` method (lines 149-160)
- Copy `BuildHydratedTranscript` method (lines 469-588)
- Copy `BuildParagraphScript` method (lines 590-608)
- Copy `RequireBookAndAsr` helper if needed for validation
- Add static Logger field

The hydration logic is self-contained - it reads TranscriptIndex from context and builds HydratedTranscript.
  </action>
  <verify>
- `dotnet build host/Ams.Core` succeeds
- New files exist with correct namespaces
  </verify>
  <done>
- ITranscriptHydrationService.cs created with HydrateTranscriptAsync signature
- TranscriptHydrationService.cs created with all extracted methods
- Build succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete AlignmentService facade and register DI</name>
  <files>host/Ams.Core/Services/Alignment/AlignmentService.cs, host/Ams.Cli/Program.cs</files>
  <action>
Complete the AlignmentService refactoring:

1. Update AlignmentService to be a pure facade:
- Add ITranscriptHydrationService dependency
- Update constructor to accept all three services
- Delegate HydrateTranscriptAsync to _hydrationService
- Remove all private helper methods (now in individual services)
- Final AlignmentService should be ~50-80 lines (just delegation)

2. Verify IAlignmentService contract unchanged:
- ComputeAnchorsAsync -> delegates to IAnchorComputeService
- BuildTranscriptIndexAsync -> delegates to ITranscriptIndexService
- HydrateTranscriptAsync -> delegates to ITranscriptHydrationService

3. Register new services in DI (host/Ams.Cli/Program.cs):
- Find existing service registration section
- Add: `services.AddSingleton<IAnchorComputeService, AnchorComputeService>();`
- Add: `services.AddSingleton<ITranscriptIndexService, TranscriptIndexService>();`
- Add: `services.AddSingleton<ITranscriptHydrationService, TranscriptHydrationService>();`
- Update IAlignmentService registration to inject the new services

4. Verify constructor compatibility:
- AlignmentService should work with DI-provided services
- Also maintain backward compatibility with optional parameters for direct instantiation
  </action>
  <verify>
- `dotnet build host/Ams.Core` succeeds
- `dotnet build host/Ams.Cli` succeeds
- `dotnet test host/Ams.Tests` passes all tests
- AlignmentService is now a lean facade (<100 lines)
  </verify>
  <done>
- AlignmentService injects all three services
- All methods delegate to appropriate service
- All services registered in DI
- AlignmentService reduced to <100 lines
- All 60 tests pass
- AUD-003 (AlignmentService god class) RESOLVED
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds for all projects
- [ ] `dotnet test host/Ams.Tests` passes all 60 tests
- [ ] AlignmentService is now <100 lines (was 641)
- [ ] 4 focused alignment services exist:
  - AnchorComputeService
  - TranscriptIndexService
  - TranscriptHydrationService
  - AlignmentService (facade)
- [ ] All services registered in DI
- [ ] IAlignmentService contract unchanged (backward compatible)
</verification>

<success_criteria>
- TranscriptHydrationService extracted
- AlignmentService is now a lean facade (<100 lines)
- All 4 alignment services registered in DI
- No breaking changes to IAlignmentService contract
- All existing tests pass
- AUD-003 fully resolved
</success_criteria>

<output>
After completion, create `.planning/phases/07-service-decomposition/07-03-SUMMARY.md`
</output>
