---
phase: 07-service-decomposition
plan: 02
type: execute
---

<objective>
Extract TranscriptIndexService from AlignmentService god class.

Purpose: Continue AlignmentService decomposition by extracting transcript index building logic.
Output: New TranscriptIndexService with BuildTranscriptIndexAsync, AlignmentService delegating to it.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-service-decomposition/07-01-SUMMARY.md

**Prior decisions affecting this phase:**
- AUD-003: AlignmentService decomposition in progress
- 07-01 completed: AnchorComputeService extracted

**Issues being addressed:**
- AUD-003: AlignmentService god class decomposition (continued)

**Current state after 07-01:**
- AlignmentService still contains BuildTranscriptIndexAsync (lines 57-147)
- Supporting methods: BuildWordOperations, BuildRollups, BuildBookPhonemeView, BuildAsrPhonemeViewAsync, BuildFallbackWindows, ComputeTiming
- These represent the largest chunk of complexity (~300 lines)

**Relevant source files:**
@host/Ams.Core/Services/Alignment/AlignmentService.cs
@host/Ams.Core/Services/Alignment/AnchorComputeService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TranscriptIndexService</name>
  <files>host/Ams.Core/Services/Alignment/ITranscriptIndexService.cs, host/Ams.Core/Services/Alignment/TranscriptIndexService.cs</files>
  <action>
Create new focused service for transcript index building:

1. Create `ITranscriptIndexService.cs`:
```csharp
public interface ITranscriptIndexService
{
    Task<TranscriptIndex> BuildTranscriptIndexAsync(
        ChapterContext context,
        TranscriptBuildOptions? options = null,
        CancellationToken cancellationToken = default);
}
```

2. Create `TranscriptIndexService.cs`:
- Add IPronunciationProvider dependency (same as AlignmentService)
- Copy `BuildTranscriptIndexAsync` method (lines 57-147)
- Copy all supporting private methods:
  - `RequireBookAndAsr` (lines 162-167)
  - `BuildPolicy` (lines 169-182)
  - `BuildAnchorDocument` (lines 184-225)
  - `BuildWordOperations` (lines 227-303)
  - `BuildRollups` (lines 305-367)
  - `BuildBookPhonemeView` (lines 369-387)
  - `BuildAsrPhonemeViewAsync` (lines 389-423)
  - `BuildFallbackWindows` (lines 425-467)
  - `ComputeTiming` (lines 610-626)
  - `ResolveDefaultAudioPath` (lines 628-637)
  - `ResolveDefaultBookIndexPath` (lines 639-640)

3. Add static Logger field matching existing pattern.

Note: BuildPolicy and BuildAnchorDocument are duplicated from AnchorComputeService. This is acceptable for now - can be consolidated to a shared utility in a future cleanup if desired.
  </action>
  <verify>
- `dotnet build host/Ams.Core` succeeds
- New files exist with correct namespaces
- All required using statements present
  </verify>
  <done>
- ITranscriptIndexService.cs created with BuildTranscriptIndexAsync signature
- TranscriptIndexService.cs created with all extracted methods
- Build succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AlignmentService to delegate transcript indexing</name>
  <files>host/Ams.Core/Services/Alignment/AlignmentService.cs</files>
  <action>
Refactor AlignmentService to delegate to TranscriptIndexService:

1. Add ITranscriptIndexService dependency:
- Add `private readonly ITranscriptIndexService _transcriptService;` field
- Update constructor to accept `ITranscriptIndexService? transcriptService = null`
- Default to `new TranscriptIndexService(_pronunciationProvider)` if null

2. Replace BuildTranscriptIndexAsync implementation:
- Keep the method signature (IAlignmentService contract unchanged)
- Delegate to `_transcriptService.BuildTranscriptIndexAsync(context, options, cancellationToken)`

3. Remove extracted methods from AlignmentService:
- Remove `BuildWordOperations`
- Remove `BuildRollups`
- Remove `BuildBookPhonemeView`
- Remove `BuildAsrPhonemeViewAsync`
- Remove `BuildFallbackWindows`
- Remove `BuildPolicy` (now in both AnchorComputeService and TranscriptIndexService)
- Remove `BuildAnchorDocument` (now in both services)
- Remove `ComputeTiming`
- Remove `ResolveDefaultAudioPath`
- Remove `ResolveDefaultBookIndexPath`
- Keep `RequireBookAndAsr` only if still needed by remaining methods

After this extraction, AlignmentService should be significantly smaller (~150 lines remaining for HydrateTranscriptAsync and its helpers).
  </action>
  <verify>
- `dotnet build host/Ams.Core` succeeds
- `dotnet test host/Ams.Tests` passes all tests
- AlignmentService.BuildTranscriptIndexAsync now delegates to TranscriptIndexService
  </verify>
  <done>
- AlignmentService injects ITranscriptIndexService
- BuildTranscriptIndexAsync delegates to injected service
- Extracted methods removed from AlignmentService
- All 60 tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build host/Ams.Core` succeeds with 0 errors
- [ ] `dotnet test host/Ams.Tests` passes all 60 tests
- [ ] New TranscriptIndexService exists and compiles
- [ ] AlignmentService delegates transcript indexing correctly
- [ ] AlignmentService reduced to ~150 lines
</verification>

<success_criteria>
- TranscriptIndexService extracted with BuildTranscriptIndexAsync and all supporting methods
- AlignmentService delegates to new service
- No breaking changes to IAlignmentService contract
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-service-decomposition/07-02-SUMMARY.md`
</output>
