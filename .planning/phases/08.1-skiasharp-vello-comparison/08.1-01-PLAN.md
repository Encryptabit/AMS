---
phase: 08.1-skiasharp-vello-comparison
plan: 01
type: execute
---

<objective>
Build a SkiaSharp GPU-accelerated waveform renderer POC to compare against the existing VelloSharp hybrid POC.

Purpose: Establish a fair comparison baseline using SkiaSharp's GPU backend for waveform rendering.
Output: Working WPF+SkiaSharp POC that renders `poc/audio_sample.wav` waveform with pan/zoom and frame timing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- VelloSharp+Avalonia: NO-GO (child window surface creation fails)
- VelloSharp+WPF owned window: GO (validated in Phase 8.2)
- Need fair comparison before committing to architecture

**Reference POC:**
@poc/HybridVelloPoc/HybridVelloPoc.Shell/VelloHostController.cs
@poc/HybridVelloPoc/HybridVelloPoc.Shell/MainWindow.xaml

**Audio test file:**
- `poc/audio_sample.wav` (~281MB) - use for waveform stress test
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WPF+SkiaSharp GPU project</name>
  <files>poc/SkiaSharpPoc/SkiaSharpPoc.sln, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/SkiaSharpPoc.Shell.csproj, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/App.xaml, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/App.xaml.cs, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/MainWindow.xaml, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/MainWindow.xaml.cs</files>
  <action>
    Create new WPF project with SkiaSharp.Views.WPF NuGet package.

    1. Create solution and project structure mirroring HybridVelloPoc layout
    2. Add NuGet references:
       - SkiaSharp (latest stable)
       - SkiaSharp.Views.WPF (provides SKGLElement for GPU rendering)
    3. Create MainWindow with:
       - Menu bar (matching HybridVelloPoc for visual parity)
       - SKGLElement as main content area (GPU-accelerated SkiaSharp surface)
       - Status bar showing FPS, frame time, zoom level
    4. Wire up SKGLElement.PaintSurface event
    5. Target net8.0-windows (same as HybridVelloPoc)

    Use SKGLElement (not SKElement) to ensure GPU acceleration via OpenGL backend.
  </action>
  <verify>dotnet build poc/SkiaSharpPoc/SkiaSharpPoc.sln succeeds with 0 errors</verify>
  <done>WPF project builds, SKGLElement renders blank GPU surface</done>
</task>

<task type="auto">
  <name>Task 2: Implement waveform renderer with pan/zoom</name>
  <files>poc/SkiaSharpPoc/SkiaSharpPoc.Shell/WaveformRenderer.cs, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/AudioLoader.cs</files>
  <action>
    Implement waveform rendering that loads poc/audio_sample.wav and draws it with interactive pan/zoom.

    1. AudioLoader.cs:
       - Load WAV file header to get sample rate, channels, bit depth
       - Memory-map or stream large file (don't load 281MB into RAM)
       - Provide method to get samples for visible range: GetSamples(startSample, endSample, targetPixelWidth)
       - Downsample on-the-fly for zoomed-out views (min/max per pixel bucket)

    2. WaveformRenderer.cs:
       - Accept SKCanvas and render waveform
       - Track view transform: offsetX (pan), scaleX (zoom)
       - Draw waveform as filled polygon or line strip
       - Use SKPaint with anti-aliasing enabled
       - Color: use a visible color (e.g., dodger blue) on dark background

    3. MainWindow.xaml.cs:
       - Mouse drag: pan view (update offsetX)
       - Mouse wheel: zoom around cursor position (update scaleX)
       - Call SKGLElement.InvalidateVisual() to trigger repaint
       - Display current zoom level and visible time range in status bar

    Performance considerations:
    - Only request samples for visible range
    - Downsample aggressively when zoomed out (1 min/max pair per pixel)
    - Avoid allocations in render loop
  </action>
  <verify>Run app, waveform displays, mouse pan/zoom works smoothly</verify>
  <done>Waveform renders from audio_sample.wav, pan/zoom interactive</done>
</task>

<task type="auto">
  <name>Task 3: Add frame timing instrumentation</name>
  <files>poc/SkiaSharpPoc/SkiaSharpPoc.Shell/FrameTimer.cs, poc/SkiaSharpPoc/SkiaSharpPoc.Shell/MainWindow.xaml.cs</files>
  <action>
    Add performance instrumentation matching what we'll add to VelloSharp POC.

    1. FrameTimer.cs:
       - Track frame times using Stopwatch
       - Calculate rolling average FPS (last 60 frames)
       - Track min/max/avg frame time in ms
       - Expose: CurrentFps, AvgFrameTimeMs, MinFrameTimeMs, MaxFrameTimeMs

    2. Update MainWindow.xaml.cs:
       - Start timer before PaintSurface
       - Stop timer after PaintSurface completes
       - Update status bar with timing info
       - Format: "FPS: {fps:F1} | Frame: {avg:F2}ms (min {min:F2} / max {max:F2})"

    3. Add on-screen overlay option:
       - Draw timing stats directly on canvas (top-right corner)
       - Toggle with 'S' key (stats overlay)
       - Use semi-transparent background for readability

    This instrumentation will be used for direct comparison with VelloSharp POC.
  </action>
  <verify>Run app, FPS counter updates in status bar and optional overlay, values are reasonable (30-144 FPS range)</verify>
  <done>Frame timing displayed, matches format we'll use for VelloSharp comparison</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build poc/SkiaSharpPoc/SkiaSharpPoc.sln` succeeds with 0 errors
- [ ] App launches and displays waveform from audio_sample.wav
- [ ] Mouse pan (drag) works smoothly
- [ ] Mouse zoom (wheel) works smoothly
- [ ] FPS counter shows reasonable values during interaction
- [ ] No visual artifacts or flickering during pan/zoom
</verification>

<success_criteria>
- SkiaSharp GPU POC builds and runs
- Waveform renders with pan/zoom matching VelloSharp POC capabilities
- Frame timing instrumentation ready for comparison
- Large audio file (~281MB) loads without memory issues
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-skiasharp-vello-comparison/08.1-01-SUMMARY.md`
</output>
