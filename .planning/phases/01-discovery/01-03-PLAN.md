---
phase: 01-discovery
plan: 03
type: execute
---

<objective>
Manually document FFmpeg P/Invoke code that wasn't captured by the call graph generator.

Purpose: The call graph generator couldn't process reflection and unsafe blocks used in FFmpeg interop. This plan fills that gap with manual documentation.
Output: Complete FFmpeg integration documentation including entry points, P/Invoke signatures, and call chains.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-discovery/01-01-SUMMARY.md
@.planning/phases/01-discovery/01-02-SUMMARY.md

**Known FFmpeg locations:**
- FFmpeg P/Invoke code is in Ams.Core
- Uses reflection and unsafe blocks
- Not captured by call graph generator due to these patterns

**Prior decisions:**
- Document FFmpeg code manually (can't use automated tools)
- This is critical for complete codebase understanding

**From Plan 01-01:**
- FILE-INVENTORY.md should identify FFmpeg-related files
- Likely in host/Ams.Core/FFmpeg/ or similar folder
</context>

<tasks>

<task type="auto">
  <name>Task 1: Locate and enumerate FFmpeg code</name>
  <files>.planning/phases/01-discovery/FFMPEG-FILES.md</files>
  <action>
    1. Search Ams.Core for FFmpeg-related files:
       - Files containing "FFmpeg", "Ff", "PInvoke", "DllImport", "unsafe"
       - Look in folders named FFmpeg, Native, Interop, etc.
    2. List all files that are part of FFmpeg integration
    3. Categorize: P/Invoke declarations | Wrappers | Utilities | Tests

    Create FFMPEG-FILES.md with:
    - Table: File | Category | Brief Description
    - Folder structure of FFmpeg code
    - Any related test files
  </action>
  <verify>FFMPEG-FILES.md exists with all FFmpeg-related files listed</verify>
  <done>All FFmpeg integration files identified and categorized</done>
</task>

<task type="auto">
  <name>Task 2: Document P/Invoke signatures and entry points</name>
  <files>.planning/phases/01-discovery/FFMPEG-PINVOKE.md</files>
  <action>
    For each FFmpeg file identified:

    1. Read the file completely
    2. Document all [DllImport] declarations
    3. Document all unsafe code blocks
    4. Document reflection usage patterns
    5. Identify public entry points (methods other code can call)

    Create FFMPEG-PINVOKE.md with:
    - Section per file
    - P/Invoke signatures with parameter types
    - Unsafe block purposes
    - Entry points with expected usage
    - Memory management patterns (allocations, frees)
  </action>
  <verify>FFMPEG-PINVOKE.md exists with all P/Invoke signatures documented</verify>
  <done>Every DllImport, unsafe block, and entry point documented</done>
</task>

<task type="auto">
  <name>Task 3: Map FFmpeg call chains</name>
  <files>.planning/phases/01-discovery/FFMPEG-CALLGRAPH.md</files>
  <action>
    Trace how FFmpeg code is called from the rest of the codebase:

    1. From entry points identified in Task 2, trace callers
    2. Build manual call graph showing: Caller -> FFmpeg Entry -> P/Invoke -> Native
    3. Document the typical flow: e.g., AudioProcessor -> FfDecoder -> avcodec_decode
    4. Identify which CLI commands trigger FFmpeg operations

    Create FFMPEG-CALLGRAPH.md with:
    - Call chain diagrams (text-based)
    - Entry point -> ultimate P/Invoke mapping
    - Which commands use FFmpeg (e.g., dsp, pipeline, etc.)
  </action>
  <verify>FFMPEG-CALLGRAPH.md exists with complete call chains</verify>
  <done>FFmpeg call paths traced from CLI commands to native calls</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] FFMPEG-FILES.md exists with all FFmpeg files listed
- [ ] FFMPEG-PINVOKE.md exists with P/Invoke signatures
- [ ] FFMPEG-CALLGRAPH.md exists with call chain documentation
- [ ] All DllImport declarations documented
- [ ] All unsafe blocks documented with purpose
- [ ] Call paths traced from CLI to native
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- FFmpeg integration fully documented (gap filled)
- Clear picture of how native code is invoked
</success_criteria>

<output>
After completion, create `.planning/phases/01-discovery/01-03-SUMMARY.md`:

# Phase 1 Plan 3: FFmpeg/P/Invoke Documentation Summary

**[Substantive one-liner about FFmpeg integration findings]**

## Accomplishments

- [FFmpeg file count and structure]
- [P/Invoke signature count]
- [Key call paths documented]

## Files Created

- `.planning/phases/01-discovery/FFMPEG-FILES.md` - FFmpeg file inventory
- `.planning/phases/01-discovery/FFMPEG-PINVOKE.md` - P/Invoke signatures
- `.planning/phases/01-discovery/FFMPEG-CALLGRAPH.md` - Call chain documentation

## Decisions Made

[Any observations about FFmpeg code organization]

## Issues Encountered

[Problems found, or "None"]

## Next Step

Ready for 01-04-PLAN.md (Module Dependency Map)
</output>
