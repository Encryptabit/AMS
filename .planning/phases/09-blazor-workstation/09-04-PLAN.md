---
phase: 09-blazor-workstation
plan: 4
type: execute
---

<objective>
Complete the Proof area with chapter review workflow: sentence list, time-synced scrolling, and keyboard shortcuts.

Purpose: Port validation-viewer functionality to Blazor, enabling chapter validation with waveform and sentence navigation.
Output: Functional chapter review page with sentence list, waveform sync, and keyboard navigation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-blazor-workstation/09-RESEARCH.md
@.planning/phases/09-blazor-workstation/09-CONTEXT.md
@.planning/phases/09-blazor-workstation/09-03-SUMMARY.md

**From CONTEXT.md - Essential UX:**
- Time-synced scrolling and keybind interface from validation-viewer must work
- Playback view is central - time-synced scrolling, keybind shortcuts

**Keyboard shortcuts from RESEARCH.md:**
- Space: Play/Pause
- Arrow Left/Right: Previous/Next sentence
- Ctrl+E: Export (placeholder for now)

**Validation-viewer patterns to port:**
@tools/validation-viewer/static/app.js (SentenceList rendering, time sync)
@tools/validation-viewer/server.py (data structures, API patterns)

**Ams.Core types for sentence data:**
The hydrate.json files contain timed sentences. We need to load and display these.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SentenceList component with time-sync</name>
  <files>host/Ams.Workstation.Server/Components/Shared/SentenceList.razor, host/Ams.Workstation.Server/Components/Shared/SentenceList.razor.css, host/Ams.Workstation.Server/Models/SentenceViewModel.cs</files>
  <action>
    1. Create SentenceViewModel.cs - DTO for sentence display:
       ```csharp
       public class SentenceViewModel
       {
           public int Id { get; set; }
           public string Text { get; set; } = "";
           public double StartTime { get; set; }
           public double EndTime { get; set; }
           public string Status { get; set; } = "ok"; // ok, warning, error
           public double? Wer { get; set; } // Word error rate
           public bool HasDiff { get; set; }
           public string? DiffHtml { get; set; }
       }
       ```

    2. Create SentenceList.razor:
       - Parameters:
         - Sentences (IEnumerable<SentenceViewModel>)
         - ActiveSentenceId (int?)
         - CurrentTime (double)
         - OnSentenceSelected (EventCallback<SentenceViewModel>)
       - Renders list of sentences with:
         - Sentence ID
         - Status indicator (colored dot or icon)
         - Sentence text
         - Optional diff display
       - Active sentence highlighting based on ActiveSentenceId
       - Auto-scroll to active sentence when it changes
       - Click handler to select sentence

    3. Time-sync logic:
       - When CurrentTime changes, find sentence containing that time
       - Update ActiveSentenceId accordingly
       - Scroll active sentence into view (use JS interop or ElementReference)

    4. SentenceList.razor.css:
       - Scrollable container with fixed height
       - Sentence item styling (padding, borders)
       - Active sentence highlight (background color)
       - Status colors (ok=green, warning=yellow, error=red)
       - Diff styling (delete=red strikethrough, insert=green underline)
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server` succeeds
    - Component compiles without errors
  </verify>
  <done>SentenceList component created with time-sync and auto-scroll</done>
</task>

<task type="auto">
  <name>Task 2: Integrate SentenceList into ChapterReview with mock data</name>
  <files>host/Ams.Workstation.Server/Components/Pages/Proof/ChapterReview.razor, host/Ams.Workstation.Server/Components/Pages/Proof/ChapterReview.razor.css, host/Ams.Workstation.Server/Services/ChapterDataService.cs</files>
  <action>
    1. Create ChapterDataService.cs:
       - For now, generates mock sentence data
       - Later will load from Ams.Core hydrate.json
       ```csharp
       public class ChapterDataService
       {
           public Task<List<SentenceViewModel>> GetSentencesAsync(string chapterName)
           {
               // Mock data for testing
               return Task.FromResult(new List<SentenceViewModel>
               {
                   new() { Id = 1, Text = "This is the first sentence.", StartTime = 0, EndTime = 3.5, Status = "ok" },
                   new() { Id = 2, Text = "Here is another sentence with more words.", StartTime = 3.5, EndTime = 7.2, Status = "ok" },
                   // ... add 10-20 mock sentences
               });
           }
       }
       ```
       Register as Scoped in Program.cs.

    2. Update ChapterReview.razor:
       - Inject ChapterDataService
       - Load sentences on initialization
       - Layout: WaveformPlayer on top, SentenceList below
       - Wire up:
         - WaveformPlayer.OnTimeUpdate -> update CurrentTime -> SentenceList syncs
         - SentenceList.OnSentenceSelected -> seek waveform to sentence start
         - SentenceList.OnSentenceSelected -> highlight region in waveform

    3. ChapterReview.razor.css:
       - Two-panel layout (waveform + sentences)
       - Proper sizing for both components
       - Responsive to container width
  </action>
  <verify>
    - ChapterReview shows both waveform and sentence list
    - Playing audio updates current time
    - Active sentence highlights based on playback position
    - Clicking sentence seeks waveform
  </verify>
  <done>ChapterReview integrates WaveformPlayer and SentenceList with sync working</done>
</task>

<task type="auto">
  <name>Task 3: Add keyboard shortcuts for playback and navigation</name>
  <files>host/Ams.Workstation.Server/Components/Pages/Proof/ChapterReview.razor</files>
  <action>
    Add HotKeys2 keyboard shortcuts to ChapterReview:

    1. Inject HotKeys service: `@inject HotKeys HotKeys`
    2. Implement IAsyncDisposable for cleanup
    3. In OnAfterRender(firstRender: true), create hotkey context:
       ```csharp
       _hotKeysContext = HotKeys.CreateContext()
           .Add(Code.Space, OnPlayPause, new() { Description = "Play/Pause" })
           .Add(Code.ArrowLeft, OnPrevSentence, new() { Description = "Previous sentence" })
           .Add(Code.ArrowRight, OnNextSentence, new() { Description = "Next sentence" })
           .Add(Code.Home, OnSkipToStart, new() { Description = "Skip to start" })
           .Add(Code.End, OnSkipToEnd, new() { Description = "Skip to end" });
       ```

    4. Implement handlers:
       - OnPlayPause: Toggle waveform play/pause
       - OnPrevSentence: Find previous sentence, seek to its start, select it
       - OnNextSentence: Find next sentence, seek to its start, select it
       - OnSkipToStart: Seek to 0, select first sentence
       - OnSkipToEnd: Seek to end

    5. Dispose context in DisposeAsync

    Note: Ensure hotkeys don't fire when typing in input fields (HotKeys2 handles this with Exclude options).
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server` succeeds
    - Space toggles play/pause
    - Arrow keys navigate between sentences
    - Home/End skip to start/end
  </verify>
  <done>Keyboard shortcuts working for playback control and sentence navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Proof area chapter review with waveform, sentence list, time-sync, and keyboard navigation</what-built>
  <how-to-verify>
    1. Run: `dotnet run --project host/Ams.Workstation.Server`
    2. Navigate to /proof/TestChapter
    3. Verify: Waveform displays at top, sentence list below
    4. Verify: Mock sentences are visible in list
    5. Test: Press Space - audio plays/pauses
    6. Test: As audio plays, active sentence should update
    7. Test: Active sentence should auto-scroll into view
    8. Test: Click a sentence - waveform seeks to that time
    9. Test: Press Right Arrow - moves to next sentence
    10. Test: Press Left Arrow - moves to previous sentence
    11. Check: No console errors
    12. Check: Layout looks reasonable (no overlapping, scrolls work)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build host/Ams.Workstation.Server` succeeds
- [ ] SentenceList component renders sentences
- [ ] Time sync works (playback position updates active sentence)
- [ ] Clicking sentence seeks waveform
- [ ] Auto-scroll works for active sentence
- [ ] Keyboard shortcuts work (Space, Arrow keys, Home, End)
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified complete chapter review workflow
- Phase 9 foundation complete - ready for real Ams.Core data integration (future phase)
</success_criteria>

<output>
After completion, create `.planning/phases/09-blazor-workstation/09-04-SUMMARY.md`:

# Phase 9 Plan 4: Proof Area & Sentence List Summary

**[One-liner describing what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 9 complete. Next: Integrate real Ams.Core data (BookContext, hydrate.json loading) in Phase 10.
</output>
