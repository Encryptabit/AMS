---
phase: 09-blazor-workstation
plan: 1
type: execute
---

<objective>
Set up Blazor Server project with .NET 9, configure DI for Ams.Core integration, and add supporting packages.

Purpose: Establish the foundational project structure that all subsequent plans build upon.
Output: Working Ams.Workstation.Server project that builds and runs, integrated with Ams.Core services.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-blazor-workstation/09-RESEARCH.md
@.planning/phases/09-blazor-workstation/09-CONTEXT.md

**Key architectural constraints from RESEARCH.md:**
- Use Blazor Server with InteractiveServer render mode (.NET 9)
- All data access through interfaces for WASM-migration readiness
- Build on Ams.Core Manager/Context paradigm (BookContext, ChapterManager, ChapterContext)
- Use Toolbelt.Blazor.HotKeys2 for keyboard shortcuts
- Use wavesurfer.js v7 via custom JS interop (not wrapper libraries)

**Project structure target:**
```
host/
├── Ams.Workstation.Server/           # New Blazor Server project
│   ├── Program.cs                    # DI registration, app config
│   ├── Components/
│   │   ├── App.razor                 # Root component
│   │   ├── Routes.razor              # Routing
│   │   └── Layout/
│   │       └── MainLayout.razor      # Shell (placeholder for Plan 2)
│   ├── wwwroot/
│   │   └── js/                       # JS interop files (Plan 3)
│   └── appsettings.json
└── Ams.sln                           # Add new project reference
```

**Relevant existing code:**
@host/Ams.Core/Runtime/Book/BookContext.cs
@host/Ams.Core/Runtime/Chapter/ChapterManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Blazor Server project structure</name>
  <files>host/Ams.Workstation.Server/Ams.Workstation.Server.csproj, host/Ams.Workstation.Server/Program.cs, host/Ams.Workstation.Server/Components/App.razor, host/Ams.Workstation.Server/Components/Routes.razor, host/Ams.Workstation.Server/Components/_Imports.razor, host/Ams.Workstation.Server/Components/Layout/MainLayout.razor, host/Ams.Workstation.Server/Properties/launchSettings.json, host/Ams.Workstation.Server/appsettings.json, host/Ams.Workstation.Server/appsettings.Development.json, host/Ams.Workstation.Server/wwwroot/css/app.css</files>
  <action>
    Create new Blazor Server project using `dotnet new blazor` template with .NET 9:
    1. Run `dotnet new blazor -n Ams.Workstation.Server -o host/Ams.Workstation.Server --interactivity Server --no-https`
    2. The template creates the basic structure with InteractiveServer render mode
    3. Verify the generated files match expected .NET 9 Blazor patterns

    The template provides:
    - Program.cs with AddRazorComponents().AddInteractiveServerComponents()
    - App.razor with HeadOutlet and Routes
    - Routes.razor with Router
    - MainLayout.razor (basic shell - we'll enhance in Plan 2)
    - _Imports.razor with common usings
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server/Ams.Workstation.Server.csproj` succeeds
    - Project files exist in expected locations
  </verify>
  <done>Blazor Server project created with .NET 9 template, builds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add project to solution and configure Ams.Core reference</name>
  <files>host/Ams.sln, host/Ams.Workstation.Server/Ams.Workstation.Server.csproj</files>
  <action>
    1. Add project to solution: `dotnet sln host/Ams.sln add host/Ams.Workstation.Server/Ams.Workstation.Server.csproj`
    2. Add project reference to Ams.Core: `dotnet add host/Ams.Workstation.Server/Ams.Workstation.Server.csproj reference host/Ams.Core/Ams.Core.csproj`
    3. Verify the .csproj has the ProjectReference to Ams.Core

    This enables direct access to Ams.Core types (BookContext, ChapterManager, etc.) without an API layer.
  </action>
  <verify>
    - `dotnet build host/Ams.sln` succeeds (entire solution builds)
    - Ams.Workstation.Server.csproj contains ProjectReference to Ams.Core
  </verify>
  <done>Project added to solution, references Ams.Core, full solution builds</done>
</task>

<task type="auto">
  <name>Task 3: Add HotKeys2 package and configure DI</name>
  <files>host/Ams.Workstation.Server/Ams.Workstation.Server.csproj, host/Ams.Workstation.Server/Program.cs</files>
  <action>
    1. Add HotKeys2 package: `dotnet add host/Ams.Workstation.Server/Ams.Workstation.Server.csproj package Toolbelt.Blazor.HotKeys2`
    2. Update Program.cs to register HotKeys2: `builder.Services.AddHotKeys2();`
    3. Add placeholder service registrations for workstation services (we'll implement these in later plans):
       - Comment showing where IChapterService, IAudioService will be registered
    4. Ensure the app runs and serves the default Blazor page

    Program.cs should follow this pattern:
    ```csharp
    using Toolbelt.Blazor.Extensions.DependencyInjection;

    var builder = WebApplication.CreateBuilder(args);

    builder.Services.AddRazorComponents()
        .AddInteractiveServerComponents();

    builder.Services.AddHotKeys2();

    // TODO: Ams.Core integration (Plan 2+)
    // builder.Services.AddScoped<IChapterService, DirectChapterService>();

    var app = builder.Build();

    app.UseStaticFiles();
    app.UseAntiforgery();

    app.MapRazorComponents<App>()
        .AddInteractiveServerRenderMode();

    app.Run();
    ```
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server` succeeds
    - `dotnet run --project host/Ams.Workstation.Server` starts and serves http://localhost:5000 (or similar)
    - Browser shows default Blazor template page
  </verify>
  <done>HotKeys2 installed, DI configured, app runs and serves pages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build host/Ams.sln` succeeds without errors
- [ ] Ams.Workstation.Server project exists with correct structure
- [ ] Project references Ams.Core
- [ ] HotKeys2 package installed and registered
- [ ] App runs and serves default Blazor page
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No build errors or warnings introduced
- Foundation ready for Layout Shell (Plan 2)
</success_criteria>

<output>
After completion, create `.planning/phases/09-blazor-workstation/09-01-SUMMARY.md`:

# Phase 9 Plan 1: Project Foundation & DI Summary

**[One-liner describing what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-02-PLAN.md (Layout Shell & Navigation)
</output>
