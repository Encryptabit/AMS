---
phase: 09-blazor-workstation
plan: 3
type: execute
---

<objective>
Create wavesurfer.js JavaScript interop module and WaveformPlayer Blazor component for audio visualization.

Purpose: Enable audio waveform display with playback controls, time tracking, and region highlighting.
Output: Reusable WaveformPlayer component that loads audio, plays/pauses, and reports time updates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-blazor-workstation/09-RESEARCH.md
@.planning/phases/09-blazor-workstation/09-CONTEXT.md
@.planning/phases/09-blazor-workstation/09-02-SUMMARY.md

**From RESEARCH.md - wavesurfer.js integration:**
- Use wavesurfer.js v7 via CDN (not wrapper libraries)
- Custom JS interop module for full API access
- Regions plugin for sentence highlighting
- Timeline plugin optional

**JS interop pattern from RESEARCH.md:**
```javascript
// wwwroot/js/waveform-interop.js
export function createWaveSurfer(elementId, options) { ... }
export function loadAudio(elementId, url) { ... }
export function play(elementId) { ... }
export function registerCallbacks(elementId, dotNetRef) { ... }
```

**Existing validation-viewer code to port:**
@tools/validation-viewer/static/app.js (WaveSurferPlayer class)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wavesurfer.js and create JS interop module</name>
  <files>host/Ams.Workstation.Server/Components/App.razor, host/Ams.Workstation.Server/wwwroot/js/waveform-interop.js</files>
  <action>
    1. Add wavesurfer.js v7 to App.razor via CDN (in HeadContent or body):
       ```html
       <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
       <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
       ```

    2. Create waveform-interop.js with these exports:
       - `createWaveSurfer(elementId, options)` - Create instance, store in window registry
       - `loadAudio(elementId, url)` - Load audio file
       - `play(elementId)` / `pause(elementId)` / `playPause(elementId)` - Playback control
       - `seekTo(elementId, seconds)` - Seek to time
       - `getCurrentTime(elementId)` - Get current playback time
       - `getDuration(elementId)` - Get audio duration
       - `setPlaybackRate(elementId, rate)` - Set speed (0.5x - 2x)
       - `registerCallbacks(elementId, dotNetRef)` - Register for events:
         - 'ready' -> OnWaveformReady
         - 'timeupdate' -> OnTimeUpdate(currentTime)
         - 'finish' -> OnPlaybackFinished
         - 'seeking' -> OnSeeking(time)
       - `addRegion(elementId, id, start, end, color)` - Add highlighted region
       - `clearRegions(elementId)` - Remove all regions
       - `highlightRegion(elementId, id, start, end)` - Highlight specific region
       - `destroy(elementId)` - Cleanup instance

    Port relevant patterns from tools/validation-viewer/static/app.js WaveSurferPlayer class.
    Store instances in `window.wavesurferInstances = {}` keyed by elementId.
  </action>
  <verify>
    - waveform-interop.js exists with all functions
    - App.razor includes wavesurfer.js script tags
    - `dotnet build host/Ams.Workstation.Server` succeeds
  </verify>
  <done>JS interop module created with full wavesurfer.js wrapper</done>
</task>

<task type="auto">
  <name>Task 2: Create WaveformPlayer Blazor component</name>
  <files>host/Ams.Workstation.Server/Components/Shared/WaveformPlayer.razor, host/Ams.Workstation.Server/Components/Shared/WaveformPlayer.razor.css</files>
  <action>
    Create reusable WaveformPlayer component:

    WaveformPlayer.razor:
    ```razor
    @inject IJSRuntime JS
    @implements IAsyncDisposable

    <div class="waveform-player">
        <div class="waveform-header">
            <span class="waveform-title">@Title</span>
            <span class="waveform-time">@FormatTime(CurrentTime) / @FormatTime(Duration)</span>
        </div>
        <div id="@_elementId" class="waveform-container"></div>
        <div class="waveform-controls">
            <button @onclick="SkipToStart" title="Skip to start">⏮</button>
            <button @onclick="PlayPause" title="Play/Pause">@(IsPlaying ? "⏸" : "▶")</button>
            <button @onclick="SkipToEnd" title="Skip to end">⏭</button>
            <input type="range" min="0.5" max="2" step="0.1" value="@PlaybackRate"
                   @onchange="OnRateChange" title="Playback speed" />
            <span>@PlaybackRate.ToString("0.0")x</span>
        </div>
    </div>
    ```

    Component features:
    - Parameters: AudioUrl, Title, OnTimeUpdate (EventCallback<double>), OnReady (EventCallback)
    - Internal state: IsPlaying, CurrentTime, Duration, PlaybackRate
    - JS module reference via IJSObjectReference
    - DotNetObjectReference for callbacks
    - Proper disposal in DisposeAsync

    Key implementation notes:
    - Only call JS interop in OnAfterRenderAsync(firstRender: true)
    - Use [JSInvokable] attribute on callback methods
    - Generate unique element ID per instance
    - Handle reconnection (re-init if needed)

    WaveformPlayer.razor.css:
    - Container sizing (100% width, fixed height ~150px)
    - Control bar styling
    - Dark theme colors matching app theme
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server` succeeds
    - Component compiles without errors
  </verify>
  <done>WaveformPlayer component created with JS interop integration</done>
</task>

<task type="auto">
  <name>Task 3: Integrate WaveformPlayer into ChapterReview page</name>
  <files>host/Ams.Workstation.Server/Components/Pages/Proof/ChapterReview.razor, host/Ams.Workstation.Server/Controllers/AudioController.cs</files>
  <action>
    1. Create minimal AudioController to serve audio files:
       - GET /api/audio?path={encodedPath} - Serves audio file with proper MIME type
       - Or use StaticFiles middleware to serve from a configured audio directory
       - For initial testing, can use a hardcoded test audio path

    2. Update ChapterReview.razor to include WaveformPlayer:
       ```razor
       @page "/proof/{ChapterName}"

       <h1>Chapter: @ChapterName</h1>

       <WaveformPlayer
           AudioUrl="@GetAudioUrl()"
           Title="@ChapterName"
           OnTimeUpdate="HandleTimeUpdate"
           OnReady="HandleWaveformReady" />

       <div class="current-time">
           Current: @FormatTime(_currentTime)
       </div>
       ```

    3. For testing, use a sample audio file:
       - Copy poc/audio_sample.wav to wwwroot/audio/ (or subset of it)
       - Or configure path to existing chapter audio

    Note: Full audio path resolution via Ams.Core comes in Plan 4. This plan just proves the waveform works.
  </action>
  <verify>
    - ChapterReview page loads with WaveformPlayer component
    - Audio file can be loaded (may need test file)
    - Play/pause controls work
    - Time display updates during playback
  </verify>
  <done>WaveformPlayer integrated into ChapterReview, audio loads and plays</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Wavesurfer.js waveform player component with playback controls</what-built>
  <how-to-verify>
    1. Run: `dotnet run --project host/Ams.Workstation.Server`
    2. Navigate to /proof/TestChapter (or any chapter name)
    3. Verify: Waveform container renders
    4. Verify: If audio loads, waveform visualizes
    5. Test: Click play button - audio plays, time updates
    6. Test: Click pause - audio pauses
    7. Test: Adjust speed slider - playback rate changes
    8. Test: Click in waveform - seeks to that position
    9. Check: No console errors in browser DevTools

    Note: If no audio file available, waveform may show loading state - that's OK.
    The key verification is that the component renders and JS interop works.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build host/Ams.Workstation.Server` succeeds
- [ ] wavesurfer.js loaded via CDN
- [ ] waveform-interop.js has all required functions
- [ ] WaveformPlayer component renders
- [ ] Playback controls work (play/pause/seek)
- [ ] Time updates flow from JS to Blazor
- [ ] No JS console errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified waveform displays and plays audio
- Ready for Proof area implementation (Plan 4)
</success_criteria>

<output>
After completion, create `.planning/phases/09-blazor-workstation/09-03-SUMMARY.md`:

# Phase 9 Plan 3: Waveform Component & JS Interop Summary

**[One-liner describing what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-04-PLAN.md (Proof Area & Sentence List)
</output>
