---
phase: 09-blazor-workstation
plan: 2
type: execute
---

<objective>
Wire up Ams.Core integration for proper workspace initialization, then create the layout shell with navigation and chapter selection.

Purpose: Establish proper Ams.Core integration so the workstation can load real book data, then build the navigation UI on top of it.
Output: Working workspace initialization, chapter loading from book-index.json, and header-based navigation.
</objective>

<imperative>
**BEFORE WRITING ANY UI CODE**: Check `.planning/references/bit-blazorui-components.md` to ensure you're not hand-rolling something BitBlazorUI already provides. Use BitTextField, BitButton, BitDropdown, BitCard, BitMessage, BitText, BitStack, etc.
</imperative>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-blazor-workstation/09-RESEARCH.md
@.planning/phases/09-blazor-workstation/09-CONTEXT.md
@.planning/phases/09-blazor-workstation/09-01-SUMMARY.md

**Key reference for workspace pattern:**
@host/Ams.Cli/Workspace/CliWorkspace.cs - Shows how CLI implements IWorkspace

**Core interfaces needed:**
@host/Ams.Core/Runtime/Workspace/IWorkspace.cs - Interface to implement
@host/Ams.Core/Runtime/Book/BookManager.cs - Manages book context
@host/Ams.Core/Runtime/Book/BookContext.cs - Book-level state
@host/Ams.Core/Runtime/Chapter/ChapterManager.cs - Chapter access

**CLI initialization pattern:**
@host/Ams.Cli/Program.cs - Shows DI setup and service registration

**Current state (from 09-01):**
- Blazor Server project exists with BitBlazorUI
- Dark theme configured
- Basic layout shell with BitPivot navigation
- WorkstationState service (needs to be enhanced)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlazorWorkspace implementing IWorkspace</name>
  <files>host/Ams.Workstation.Server/Services/BlazorWorkspace.cs</files>
  <action>
    Create a workspace implementation following CliWorkspace pattern:

    ```csharp
    using Ams.Core.Runtime.Artifacts;
    using Ams.Core.Runtime.Book;
    using Ams.Core.Runtime.Chapter;
    using Ams.Core.Runtime.Workspace;

    namespace Ams.Workstation.Server.Services;

    public sealed class BlazorWorkspace : IWorkspace, IDisposable
    {
        private readonly BookManager _manager;
        private readonly string _rootPath;
        private bool _disposed;

        public BlazorWorkspace(string rootPath, IArtifactResolver? resolver = null)
        {
            if (string.IsNullOrWhiteSpace(rootPath))
                throw new ArgumentException("Root path required.", nameof(rootPath));

            _rootPath = Path.GetFullPath(rootPath);
            var descriptor = BuildDescriptor(_rootPath);
            _manager = new BookManager(new[] { descriptor }, resolver ?? FileArtifactResolver.Instance);
        }

        public string RootPath => _rootPath;
        public BookContext Book => _manager.Current;

        public ChapterContextHandle OpenChapter(ChapterOpenOptions options)
        {
            var bookIndex = options.BookIndexFile ?? ResolveDefaultBookIndex();
            var chapterDir = options.ChapterDirectory;

            if (chapterDir is null && options.ChapterId is { Length: > 0 })
            {
                chapterDir = new DirectoryInfo(Path.Combine(_rootPath, options.ChapterId));
            }

            return Book.Chapters.CreateContext(
                bookIndex,
                options.AsrFile,
                options.TranscriptFile,
                options.HydrateFile,
                options.AudioFile,
                chapterDir,
                options.ChapterId,
                options.ReloadBookIndex);
        }

        private FileInfo ResolveDefaultBookIndex()
        {
            var path = Path.Combine(_rootPath, "book-index.json");
            return new FileInfo(path);
        }

        private static BookDescriptor BuildDescriptor(string rootPath)
        {
            var trimmed = rootPath.TrimEnd(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);
            var bookId = Path.GetFileName(trimmed);
            if (string.IsNullOrWhiteSpace(bookId)) bookId = "workspace";
            return new BookDescriptor(bookId, trimmed, Array.Empty<ChapterDescriptor>());
        }

        public void Dispose()
        {
            if (_disposed) return;
            _disposed = true;
            // BookManager doesn't implement IDisposable currently
        }
    }
    ```
  </action>
  <verify>
    - File compiles without errors
    - Implements IWorkspace interface correctly
  </verify>
  <done>BlazorWorkspace created following CliWorkspace pattern</done>
</task>

<task type="auto">
  <name>Task 2: Enhance WorkstationState with workspace integration</name>
  <files>host/Ams.Workstation.Server/Services/WorkstationState.cs</files>
  <action>
    Update WorkstationState to manage BlazorWorkspace and load chapters from book-index.json:

    ```csharp
    using System.Text.Json;
    using Ams.Core.Runtime.Workspace;

    namespace Ams.Workstation.Server.Services;

    public class WorkstationState : IDisposable
    {
        private BlazorWorkspace? _workspace;
        private bool _disposed;

        public string? WorkingDirectory { get; private set; }
        public string? CurrentChapter { get; set; }
        public List<string> AvailableChapters { get; private set; } = new();
        public bool HasBookIndex => !string.IsNullOrEmpty(WorkingDirectory)
            && File.Exists(Path.Combine(WorkingDirectory, "book-index.json"));

        public IWorkspace? Workspace => _workspace;

        public bool SetWorkingDirectory(string path)
        {
            if (string.IsNullOrWhiteSpace(path)) return false;

            var trimmed = path.Trim();
            if (!Directory.Exists(trimmed)) return false;

            // Dispose previous workspace
            _workspace?.Dispose();
            _workspace = null;

            WorkingDirectory = trimmed;
            CurrentChapter = null;
            AvailableChapters.Clear();

            // Load chapters if book-index.json exists
            if (HasBookIndex)
            {
                LoadChaptersFromIndex();
                _workspace = new BlazorWorkspace(trimmed);
            }

            return true;
        }

        private void LoadChaptersFromIndex()
        {
            var indexPath = Path.Combine(WorkingDirectory!, "book-index.json");
            try
            {
                var json = File.ReadAllText(indexPath);
                using var doc = JsonDocument.Parse(json);

                if (doc.RootElement.TryGetProperty("chapters", out var chapters))
                {
                    foreach (var chapter in chapters.EnumerateArray())
                    {
                        if (chapter.TryGetProperty("id", out var id))
                        {
                            AvailableChapters.Add(id.GetString() ?? "");
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                // Log error but don't throw - chapters will be empty
                Console.WriteLine($"Failed to load book-index.json: {ex.Message}");
            }
        }

        public void Clear()
        {
            _workspace?.Dispose();
            _workspace = null;
            WorkingDirectory = null;
            CurrentChapter = null;
            AvailableChapters.Clear();
        }

        public void Dispose()
        {
            if (_disposed) return;
            _disposed = true;
            _workspace?.Dispose();
        }
    }
    ```
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server` succeeds
    - WorkstationState can load chapters from real book-index.json
  </verify>
  <done>WorkstationState enhanced with BlazorWorkspace integration</done>
</task>

<task type="auto">
  <name>Task 3: Register Ams.Core services in DI</name>
  <files>host/Ams.Workstation.Server/Program.cs</files>
  <action>
    Add necessary Ams.Core service registrations following CLI pattern:

    ```csharp
    using Ams.Core.Services;
    using Ams.Core.Services.Alignment;
    using Ams.Core.Services.Interfaces;
    using Ams.Core.Application.Validation;

    // In Program.cs, add after existing service registrations:

    // Ams.Core services (matching CLI setup)
    builder.Services.AddSingleton<IAsrService, AsrService>();
    builder.Services.AddSingleton<IAnchorComputeService, AnchorComputeService>();
    builder.Services.AddSingleton<ITranscriptIndexService, TranscriptIndexService>();
    builder.Services.AddSingleton<ITranscriptHydrationService, TranscriptHydrationService>();
    builder.Services.AddSingleton<IAlignmentService, AlignmentService>();
    builder.Services.AddSingleton<ValidationService>();
    builder.Services.AddSingleton<PipelineService>();
    ```

    Note: Keep services as Singleton since they're stateless. WorkstationState remains Scoped (per circuit).
  </action>
  <verify>
    - `dotnet build host/Ams.Workstation.Server` succeeds
    - No missing dependency errors at startup
  </verify>
  <done>Ams.Core services registered in DI container</done>
</task>

<task type="auto">
  <name>Task 4: Update HeaderControls to use enhanced WorkstationState</name>
  <files>host/Ams.Workstation.Server/Components/Layout/HeaderControls.razor</files>
  <action>
    Update HeaderControls to use the new WorkstationState.SetWorkingDirectory() method
    which returns success/failure and handles workspace creation:

    1. Change SetDirectory() to use State.SetWorkingDirectory(path)
    2. Handle return value for error messaging
    3. RefreshChapterList() now just reads from State.AvailableChapters
    4. Remove placeholder chapter generation - use real data

    The component should:
    - Call State.SetWorkingDirectory(path) which returns bool
    - If false, show error message
    - If true, populate chapterItems from State.AvailableChapters
    - Chapter dropdown shows real chapter IDs from book-index.json
  </action>
  <verify>
    - Build succeeds
    - Setting a valid working directory with book-index.json loads real chapters
  </verify>
  <done>HeaderControls uses enhanced WorkstationState</done>
</task>

<task type="auto">
  <name>Task 5: Update remaining pages to reflect state changes</name>
  <files>host/Ams.Workstation.Server/Components/Pages/Home.razor, host/Ams.Workstation.Server/Components/Pages/Proof/Index.razor, host/Ams.Workstation.Server/Components/Pages/Proof/ChapterReview.razor</files>
  <action>
    Update pages to work with the enhanced WorkstationState:

    1. Home.razor - Show workspace info (path, chapter count, workspace ready status)
    2. Proof/Index.razor - List chapters from State.AvailableChapters
    3. Proof/ChapterReview.razor - Can access State.Workspace?.OpenChapter() for future use

    All pages should handle the case where no workspace is set gracefully.
  </action>
  <verify>
    - All pages render correctly with and without workspace set
    - Navigation between pages works
  </verify>
  <done>All pages updated for enhanced state management</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    - BlazorWorkspace implementing IWorkspace (matching CliWorkspace pattern)
    - Enhanced WorkstationState with real book-index.json loading
    - Ams.Core services registered in DI
    - Header with working directory input, chapter dropdown
    - Dark theme UI with BitBlazorUI components
  </what-built>
  <how-to-verify>
    1. Run: `dotnet run --project host/Ams.Workstation.Server`
    2. Open browser to http://localhost:5000
    3. Verify: Dark theme is active
    4. Enter a path to a directory WITH book-index.json (e.g., a real work directory)
    5. Click "Set" - chapter dropdown should populate with real chapter IDs
    6. Enter a path WITHOUT book-index.json - should show warning
    7. Select a chapter from dropdown - should navigate to /proof/{chapter}
    8. Click Prep/Proof/Polish tabs - navigation should work
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] BlazorWorkspace implements IWorkspace correctly
- [ ] WorkstationState loads chapters from real book-index.json
- [ ] Ams.Core services registered in DI
- [ ] `dotnet build host/Ams.Workstation.Server` succeeds
- [ ] Header shows working directory input and chapter dropdown
- [ ] Real chapters load when valid directory is set
- [ ] Navigation works between all areas
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified workspace integration works with real data
- Ready for waveform component (Plan 3)
</success_criteria>

<output>
After completion, create `.planning/phases/09-blazor-workstation/09-02-SUMMARY.md`:

# Phase 9 Plan 2: Ams.Core Integration & Layout Shell Summary

**[One-liner describing what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-03-PLAN.md (Waveform Component & JS Interop)
</output>
