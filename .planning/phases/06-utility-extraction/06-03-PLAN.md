---
phase: 06-utility-extraction
plan: 03
type: execute
---

<objective>
Fix failing FFmpeg filter tests (Trim and FadeIn) to achieve 60/60 test pass rate.

Purpose: Resolve the 2 pre-existing test failures in AudioProcessorFilterTests, improving test suite reliability.
Output: All 60 tests passing, FFmpeg filter string construction verified as locale-independent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-recommendations/ACTION-LIST.md

**Prior decisions:**
- AUD-007: FFmpeg filter tests failing - FIX
- AUD-020: Ams.Tests failing - FIX (same root cause)

**Failing tests:**
@host/Ams.Tests/AudioProcessorFilterTests.cs
- `Trim_ReturnsExpectedSegment` - FFmpeg filter syntax error
- `FadeIn_SetsLeadingSamplesToZero` - FFmpeg filter syntax error

**Root cause hypothesis:** Locale-dependent decimal formatting in filter strings.
When running on systems with non-US locale, "0.5" might become "0,5" which FFmpeg rejects.

**Files likely needing fixes:**
- host/Ams.Core/Processors/AudioProcessor.cs (Trim, FadeIn methods)
- host/Ams.Core/Services/Integrations/FFmpeg/FfFilterGraph.cs (filter string construction)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate FFmpeg filter test failures</name>
  <files>host/Ams.Tests/AudioProcessorFilterTests.cs, host/Ams.Core/Processors/AudioProcessor.cs</files>
  <action>
    1. Run the specific failing tests to capture error messages:
       ```
       dotnet test host/Ams.Tests --filter "FullyQualifiedName~Trim_ReturnsExpectedSegment"
       dotnet test host/Ams.Tests --filter "FullyQualifiedName~FadeIn_SetsLeadingSamplesToZero"
       ```

    2. Locate the Trim and FadeIn methods in AudioProcessor.cs

    3. Trace the filter string construction:
       - Find where time values (TimeSpan) are converted to strings
       - Check for use of `.ToString()` without CultureInfo.InvariantCulture
       - Check FfFilterGraph.cs for similar issues

    4. Search for potential locale issues:
       ```
       grep -r "ToString\(\)" host/Ams.Core/Services/Integrations/FFmpeg/ --include="*.cs"
       grep -r "\.TotalSeconds" host/Ams.Core --include="*.cs"
       ```

    5. Document findings:
       - Exact location of locale-dependent formatting
       - Which methods need fixing
       - What the fix should be (FormattableString.Invariant or CultureInfo.InvariantCulture)
  </action>
  <verify>
    - Test error messages captured
    - Root cause identified (specific file and line)
    - Fix approach documented
  </verify>
  <done>Root cause identified, fix approach determined</done>
</task>

<task type="auto">
  <name>Task 2: Fix locale-dependent filter string formatting</name>
  <files>host/Ams.Core/Processors/AudioProcessor.cs, host/Ams.Core/Services/Integrations/FFmpeg/FfFilterGraph.cs</files>
  <action>
    Based on Task 1 findings, apply fixes:

    1. For any `.ToString()` calls on numeric types used in FFmpeg filters:
       - Replace with `.ToString(CultureInfo.InvariantCulture)`
       - Or use `FormattableString.Invariant($"...")`

    2. For TimeSpan.TotalSeconds used in filter strings:
       - Ensure formatting uses invariant culture
       - Example: `FormattableString.Invariant($"{timespan.TotalSeconds:F6}")`

    3. Common patterns to fix:
       - `atrim=start={start}:end={end}` - both start/end need invariant formatting
       - `afade=t=in:st={start}:d={duration}` - st and d need invariant formatting

    4. Add `using System.Globalization;` where needed

    5. Review AsrService.cs as a reference - it already uses:
       `FormattableString.Invariant($"{weight:F6}*c{ch}")`
       Follow this pattern for consistency.

    6. Consider adding a helper method if multiple places need fixing:
       ```csharp
       private static string Seconds(TimeSpan ts) =>
           FormattableString.Invariant($"{ts.TotalSeconds:F6}");
       ```
  </action>
  <verify>
    - `dotnet build host/Ams.Core` succeeds
    - `dotnet test host/Ams.Tests --filter "FullyQualifiedName~AudioProcessorFilterTests"` - all 3 tests pass
    - `dotnet test host/Ams.Tests` - 60/60 tests pass (up from 58/60)
  </verify>
  <done>
    - FFmpeg filter strings use invariant culture formatting
    - Trim_ReturnsExpectedSegment passes
    - FadeIn_SetsLeadingSamplesToZero passes
    - All 60 tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build host/Ams.sln` succeeds with 0 errors
- [ ] `dotnet test host/Ams.Tests` passes 60/60 tests
- [ ] No locale-dependent decimal formatting in FFmpeg filter strings
- [ ] Filter strings verified to work with both "." and "," decimal separators
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Test pass rate improved from 58/60 to 60/60
- Issues AUD-007, AUD-020 resolved
- FFmpeg filter string construction is locale-safe
</success_criteria>

<output>
After completion, create `.planning/phases/06-utility-extraction/06-03-SUMMARY.md`
</output>
