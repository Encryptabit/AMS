---
phase: 06-utility-extraction
plan: 01
type: execute
---

<objective>
Extract ChapterLabelResolver utility from duplicated code in ChapterContext and AlignmentService.

Purpose: Eliminate ~35 lines of duplicate section resolution logic and create reusable utility for Phase 7 AlignmentService decomposition.
Output: New ChapterLabelResolver.cs utility with unit tests, ChapterContext and AlignmentService refactored to use it.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-recommendations/ACTION-LIST.md

**Prior decisions:**
- AUD-004: Section resolution duplication identified - EXTRACT to utility
- AUD-012: Duplicate methods in AlignmentService - EXTRACT

**Source files with duplication:**
@host/Ams.Core/Runtime/Chapter/ChapterContext.cs
@host/Ams.Core/Services/Alignment/AlignmentService.cs

**Duplicated methods (identical logic in both files):**
- `TryExtractChapterNumber()` - regex-based chapter number extraction
- `EnumerateLabelCandidates()` - generates label variations for matching
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChapterLabelResolver utility</name>
  <files>host/Ams.Core/Common/ChapterLabelResolver.cs</files>
  <action>
    1. Create directory `host/Ams.Core/Common/` if it doesn't exist
    2. Create `ChapterLabelResolver.cs` as a static utility class
    3. Move from ChapterContext.cs:
       - `TryExtractChapterNumber()` method (lines 146-161)
       - `EnumerateLabelCandidates()` method (lines 127-144)
       - The compiled regex pattern used by TryExtractChapterNumber
    4. Add namespace `Ams.Core.Common`
    5. Add XML documentation comments explaining:
       - Purpose: resolve chapter/section labels from book text
       - Usage: call `EnumerateLabelCandidates()` to get match variations
       - Usage: call `TryExtractChapterNumber()` to extract numeric chapter
    6. Add a convenience method `ResolveSection(string label)` that combines both

    Note: Both ChapterContext and AlignmentService have identical implementations.
    Use the ChapterContext version as the source of truth.
  </action>
  <verify>
    - File exists at host/Ams.Core/Common/ChapterLabelResolver.cs
    - `dotnet build host/Ams.Core` succeeds (new file compiles)
  </verify>
  <done>ChapterLabelResolver.cs created with TryExtractChapterNumber, EnumerateLabelCandidates, and ResolveSection methods</done>
</task>

<task type="auto">
  <name>Task 2: Refactor callers to use ChapterLabelResolver</name>
  <files>host/Ams.Core/Runtime/Chapter/ChapterContext.cs, host/Ams.Core/Services/Alignment/AlignmentService.cs</files>
  <action>
    1. In ChapterContext.cs:
       - Add `using Ams.Core.Common;`
       - Remove `TryExtractChapterNumber()` method definition (lines ~146-161)
       - Remove `EnumerateLabelCandidates()` method definition (lines ~127-144)
       - Remove the compiled regex field if it was local to these methods
       - Update any internal calls to use `ChapterLabelResolver.TryExtractChapterNumber()`
       - Update any internal calls to use `ChapterLabelResolver.EnumerateLabelCandidates()`

    2. In AlignmentService.cs:
       - Add `using Ams.Core.Common;`
       - Remove `TryExtractChapterNumber()` method definition (lines ~228-244)
       - Remove `EnumerateLabelCandidates()` method definition (lines ~246-264)
       - Update any internal calls to use `ChapterLabelResolver.TryExtractChapterNumber()`
       - Update any internal calls to use `ChapterLabelResolver.EnumerateLabelCandidates()`

    3. Search for any other callers: `grep -r "TryExtractChapterNumber\|EnumerateLabelCandidates" host/`
       Update any additional callers found.
  </action>
  <verify>
    - `dotnet build host/Ams.Core` succeeds with 0 errors
    - `dotnet test host/Ams.Tests` passes (58/60, 2 pre-existing FFmpeg failures)
    - grep for TryExtractChapterNumber only finds ChapterLabelResolver.cs
    - grep for EnumerateLabelCandidates only finds ChapterLabelResolver.cs
  </verify>
  <done>
    - ChapterContext.cs no longer contains duplicate methods
    - AlignmentService.cs no longer contains duplicate methods
    - Both files use ChapterLabelResolver utility
    - All tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build host/Ams.sln` succeeds with 0 errors
- [ ] `dotnet test host/Ams.Tests` passes (58/60, 2 pre-existing FFmpeg failures)
- [ ] ChapterLabelResolver.cs exists in host/Ams.Core/Common/
- [ ] ChapterContext.cs reduced by ~35 lines
- [ ] AlignmentService.cs reduced by ~35 lines
- [ ] No duplicate TryExtractChapterNumber implementations remain
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ~70 lines of duplicate code eliminated
- ChapterLabelResolver utility ready for Phase 7 AlignmentService decomposition
</success_criteria>

<output>
After completion, create `.planning/phases/06-utility-extraction/06-01-SUMMARY.md`
</output>
