@page "/proof/{ChapterName}"
@inject Ams.Workstation.Server.Services.WorkstationState State
@inject NavigationManager Navigation

<PageTitle>@ChapterName - Proof - AMS Workstation</PageTitle>

<div class="chapter-review">
    <BitStack Horizontal="false" Gap="1rem" Style="height: 100%;">
        <BitCard FullSize="true" Class="review-content">
            <BitStack Horizontal="false" Gap="1.5rem">
                @* Waveform Player *@
                <div class="waveform-section">
                    <WaveformPlayer
                        AudioUrl="@GetAudioUrl()"
                        Title="@GetDisplayTitle()"
                        TimeUpdated="HandleTimeUpdate"
                        OnReady="HandleWaveformReady"
                        OnSeek="HandleSeek"
                        OnFinished="HandlePlaybackFinished" />
                </div>

                @* Current Time Display *@
                <BitCard Background="BitColorKind.Secondary" Class="time-display">
                    <BitStack Horizontal="true" Gap="1rem" VerticalAlign="BitAlignment.Center">
                        <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">
                            Current Position:
                        </BitText>
                        <BitText Typography="BitTypography.Subtitle2" Style="font-family: monospace;">
                            @FormatTime(_currentTime)
                        </BitText>
                        @if (_isWaveformReady)
                        {
                            <BitBadge Appearance="BitAppearance.Primary" Color="BitColor.Success">
                                Ready
                            </BitBadge>
                        }
                    </BitStack>
                </BitCard>

                @* Placeholder for Sentence List (Plan 4) *@
                <div class="panel-preview">
                    <BitText Typography="BitTypography.Caption1" Color="BitColor.SecondaryForeground"
                             Style="text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                        Sentence List Panel
                    </BitText>
                    <div class="panel-mock sentence-mock">
                        <BitText Color="BitColor.SecondaryForeground">
                            Sentence list with timing data coming in Plan 4
                        </BitText>
                    </div>
                </div>

                @* Chapter Info *@
                <BitCard Background="BitColorKind.Secondary" Class="chapter-info">
                    <BitText Typography="BitTypography.Subtitle2" Color="BitColor.SecondaryForeground"
                             Style="margin-bottom: 0.5rem;">
                        Current State
                    </BitText>
                    <BitStack Horizontal="false" Gap="0.25rem">
                        <BitStack Horizontal="true" Gap="0.5rem">
                            <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">Chapter:</BitText>
                            <BitText Typography="BitTypography.Body2" Style="font-family: monospace;">
                                @Uri.UnescapeDataString(ChapterName ?? "N/A")
                            </BitText>
                        </BitStack>
                        <BitStack Horizontal="true" Gap="0.5rem">
                            <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">Working Directory:</BitText>
                            <BitText Typography="BitTypography.Body2" Style="font-family: monospace;">
                                @(State.WorkingDirectory ?? "No directory set")
                            </BitText>
                        </BitStack>
                        <BitStack Horizontal="true" Gap="0.5rem">
                            <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">Workspace:</BitText>
                            <BitText Typography="BitTypography.Body2" Style="font-family: monospace;">
                                @(State.Workspace != null ? "Ready" : "Not initialized")
                            </BitText>
                        </BitStack>
                    </BitStack>
                </BitCard>
            </BitStack>
        </BitCard>
    </BitStack>
</div>

@code {
    private double _currentTime;
    private bool _isWaveformReady;

    [Parameter]
    public string? ChapterName { get; set; }

    protected override void OnParametersSet()
    {
        // Update the current chapter in state
        if (!string.IsNullOrEmpty(ChapterName))
        {
            State.CurrentChapter = Uri.UnescapeDataString(ChapterName);
        }

        // Reset waveform ready state when chapter changes
        _isWaveformReady = false;
        _currentTime = 0;
    }

    private string GetAudioUrl()
    {
        // TODO: In Plan 4, use workspace to get actual chapter audio path
        // For now, use the chapter endpoint which will fall back to sample audio
        if (!string.IsNullOrEmpty(ChapterName))
        {
            return $"/api/audio/chapter/{Uri.EscapeDataString(ChapterName)}";
        }
        return "/api/audio"; // Falls back to sample audio
    }

    private string GetDisplayTitle()
    {
        return Uri.UnescapeDataString(ChapterName ?? "Audio");
    }

    private void HandleTimeUpdate(double time)
    {
        _currentTime = time;
    }

    private void HandleWaveformReady()
    {
        _isWaveformReady = true;
        StateHasChanged();
    }

    private void HandleSeek(double time)
    {
        _currentTime = time;
    }

    private void HandlePlaybackFinished()
    {
        // Could add logic here for auto-advance to next chapter
    }

    private static string FormatTime(double seconds)
    {
        if (double.IsNaN(seconds) || double.IsInfinity(seconds)) return "0:00.000";
        var mins = (int)(seconds / 60);
        var secs = (int)(seconds % 60);
        var ms = (int)((seconds % 1) * 1000);
        return $"{mins}:{secs:D2}.{ms:D3}";
    }
}

<style>
    .chapter-review {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .review-content {
        flex: 1;
        overflow: auto;
    }

    .waveform-section {
        width: 100%;
    }

    .time-display {
        padding: 0.75rem 1rem;
    }

    .panel-preview {
        display: flex;
        flex-direction: column;
    }

    .panel-mock {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bit-clr-bg-sec);
        border: 1px dashed var(--bit-clr-brd-sec);
        border-radius: 4px;
    }

    .sentence-mock {
        height: 200px;
    }

    .chapter-info {
        padding: 1rem;
    }
</style>
