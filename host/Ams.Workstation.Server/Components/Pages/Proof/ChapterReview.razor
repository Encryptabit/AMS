@page "/proof/{ChapterName}"
@inject Ams.Workstation.Server.Services.BlazorWorkspace Workspace
@inject NavigationManager Navigation

<PageTitle>@ChapterName - Proof - AMS Workstation</PageTitle>


<BitGrid Columns="12">
    <BitGridItem ColumnSpan="12" style="min-width: 0;">
        <section class="proof-review">
            <WaveformPlayer
                AudioUrl="@GetAudioUrl()"
                Title="@GetDisplayTitle()"
                TimeUpdated="HandleTimeUpdate"
                OnReady="HandleWaveformReady"
                OnSeek="HandleSeek"
                OnFinished="HandlePlaybackFinished"/>
        </section>
    </BitGridItem>
    <BitGridItem ColumnSpan="12">
        <SentenceList></SentenceList>
    </BitGridItem>
</BitGrid>


@* *@
@* <BitStack Horizontal="false" Gap="1rem" Style="height: 100%;"> *@
@*     <BitCard FullSize="true" Class="review-content"> *@
@*         <BitStack Horizontal="false" Gap="1.5rem"> *@
@*             $1$ Waveform Player #1# *@
@*             <div class="waveform-section"> *@
@*                 *@
@*             </div> *@
@* *@
@*             $1$ Current Time Display #1# *@
@*             <BitCard Background="BitColorKind.Secondary" Class="time-display"> *@
@*                 <BitStack Horizontal="true" Gap="1rem" VerticalAlign="BitAlignment.Center"> *@
@*                     <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground"> *@
@*                         Current Position: *@
@*                     </BitText> *@
@*                     <BitText Typography="BitTypography.Subtitle2" Style="font-family: monospace;"> *@
@*                         @FormatTime(_currentTime) *@
@*                     </BitText> *@
@*                     @if (_isWaveformReady) *@
@*                     { *@
@*                         <BitBadge Appearance="BitAppearance.Primary" Color="BitColor.Success"> *@
@*                             Ready *@
@*                         </BitBadge> *@
@*                     } *@
@*                 </BitStack> *@
@*             </BitCard> *@
@* *@
@*             $1$ Placeholder for Sentence List (Plan 4) #1# *@
@*             <div class="panel-preview"> *@
@*                 <BitText Typography="BitTypography.Caption1" Color="BitColor.SecondaryForeground" *@
@*                          Style="text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;"> *@
@*                     Sentence List Panel *@
@*                 </BitText> *@
@*                 <div class="panel-mock sentence-mock"> *@
@*                     <BitText Color="BitColor.SecondaryForeground"> *@
@*                         Sentence list with timing data coming in Plan 4 *@
@*                     </BitText> *@
@*                 </div> *@
@*             </div> *@
@* *@
@*             $1$ Chapter Info #1# *@
@*             <BitCard Background="BitColorKind.Secondary" Class="chapter-info"> *@
@*                 <BitText Typography="BitTypography.Subtitle2" Color="BitColor.SecondaryForeground" *@
@*                          Style="margin-bottom: 0.5rem;"> *@
@*                     Current State *@
@*                 </BitText> *@
@*                 <BitStack Horizontal="false" Gap="0.25rem"> *@
@*                     <BitStack Horizontal="true" Gap="0.5rem"> *@
@*                         <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">Chapter:</BitText> *@
@*                         <BitText Typography="BitTypography.Body2" Style="font-family: monospace;"> *@
@*                             @Uri.UnescapeDataString(ChapterName ?? "N/A") *@
@*                         </BitText> *@
@*                     </BitStack> *@
@*                     <BitStack Horizontal="true" Gap="0.5rem"> *@
@*                         <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">Working Directory:</BitText> *@
@*                         <BitText Typography="BitTypography.Body2" Style="font-family: monospace;"> *@
@*                             @(State.WorkingDirectory ?? "No directory set") *@
@*                         </BitText> *@
@*                     </BitStack> *@
@*                     <BitStack Horizontal="true" Gap="0.5rem"> *@
@*                         <BitText Typography="BitTypography.Body2" Color="BitColor.SecondaryForeground">Workspace:</BitText> *@
@*                         <BitText Typography="BitTypography.Body2" Style="font-family: monospace;"> *@
@*                             @(State.Workspace != null ? "Ready" : "Not initialized") *@
@*                         </BitText> *@
@*                     </BitStack> *@
@*                 </BitStack> *@
@*             </BitCard> *@
@*         </BitStack> *@
@*     </BitCard> *@
@* </BitStack> *@

@code {
    private double _currentTime;
    private bool _isWaveformReady;

    [Parameter] public string? ChapterName { get; set; }

    protected override void OnParametersSet()
    {
        // Ensure chapter is selected (opens handle if not already)
        if (!string.IsNullOrEmpty(ChapterName))
        {
            var decodedName = Uri.UnescapeDataString(ChapterName);
            if (Workspace.CurrentChapterName != decodedName)
            {
                Workspace.SelectChapter(decodedName);
            }
        }

        // Reset waveform ready state when chapter changes
        _isWaveformReady = false;
        _currentTime = 0;
    }

    private string GetAudioUrl()
    {
        // TODO: In Plan 4, use workspace to get actual chapter audio path
        // For now, use the chapter endpoint which will fall back to sample audio
        if (!string.IsNullOrEmpty(ChapterName))
        {
            return $"/api/audio/chapter/{Uri.EscapeDataString(ChapterName)}";
        }

        return "/api/audio"; // Falls back to sample audio
    }

    private string GetDisplayTitle()
    {
        return Uri.UnescapeDataString(ChapterName ?? "Audio");
    }

    private void HandleTimeUpdate(double time)
    {
        _currentTime = time;
    }

    private void HandleWaveformReady()
    {
        _isWaveformReady = true;
        StateHasChanged();
    }

    private void HandleSeek(double time)
    {
        _currentTime = time;
    }

    private void HandlePlaybackFinished()
    {
        // Could add logic here for auto-advance to next chapter
    }

    private static string FormatTime(double seconds)
    {
        if (double.IsNaN(seconds) || double.IsInfinity(seconds)) return "0:00.000";
        var mins = (int)(seconds / 60);
        var secs = (int)(seconds % 60);
        var ms = (int)((seconds % 1) * 1000);
        return $"{mins}:{secs:D2}.{ms:D3}";
    }

}


