@page "/"

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False" @onkeydown="HandleKeyDown" tabindex="0">
    <MudGrid>
        <MudItem md="2">
            <MudPaper Elevation="2" Class="px-2" Style="height: 100%;">
                <MudStack Spacing="2" Class="pa-3">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Workspace</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @WorkspaceDescription
                    </MudText>

                    <MudTextField @bind-Value="_chapterFilter"
                                  Placeholder="Search chapters..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"/>

                    @if (_isChaptersLoading)
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary"/>
                    }


                    <MudList T="ChapterListItemDto" Dense="true" Class="chapter-list">
                        @if (FilteredChapters.Count == 0)
                        {
                            <MudListItem T="ChapterListItemDto" Disabled="true">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No chapters</MudText>
                            </MudListItem>
                        }
                        else
                        {
                            @foreach (var chapter in FilteredChapters)
                            {
                                <MudListItem T="ChapterListItemDto"
                                             Class="@GetChapterItemClass(chapter)"
                                             OnClick="@(() => SelectChapterAsync(chapter))">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2">@chapter.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @FormatDuration(chapter.DurationSeconds) • @chapter.SentenceCount sentences
                                        </MudText>
                                    </MudStack>
                                </MudListItem>
                            }
                        }
                    </MudList>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="8">
            <MudPaper Elevation="2" Class="pa-2" Style="height: 100%;">
                @if (_isChapterLoading)
                {
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudProgressCircular Indeterminate="true" Size="Size.Large"/>
                            <MudText Typo="Typo.subtitle1">Loading chapter…</MudText>
                        </MudStack>
                    }
                    else if (SelectedChapter is null)
                    {
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.LibraryMusic" Size="Size.Large"
                                     Color="Color.Secondary"/>
                            <MudText Typo="Typo.h6" Color="Color.Secondary">Select a chapter to begin</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.h5">@SelectedChapter.Name</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">
                            @SelectedChapter.SentenceCount sentences
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                            @FormatDuration(SelectedChapter.DurationSeconds)
                        </MudChip>

                        <ManuscriptPanel Sentences="@SentencesToDisplay"
                                         SelectedSentence="@_selectedSentence"
                                         OnSentenceSelected="@OnSentenceSelected"/>
                    }
            </MudPaper>
        </MudItem>
        <MudItem xs="2">
            <MudPaper Elevation="2" Class="pa-2" Style="height: 100%;">
                <TimecodePanel Sentences="@SentencesToDisplay"
                               SelectedSentence="@_selectedSentence"/>
            </MudPaper>
        </MudItem>
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 200px;">
            @if (SelectedChapter is not null)
            {
                <AudioTransport @ref="_audioTransport"
                                AudioSource="@AudioSource"
                                CurrentTime="@_currentPlaybackTime"
                                TotalTime="@SelectedChapter?.DurationSeconds"
                                IsPlaying="@_isPlaying"
                                CanNavigatePrevious="@CanNavigatePrevious"
                                CanNavigateNext="@CanNavigateNext"
                                CanExport="@(_selectedSentence != null)"
                                LastExportMessage="@_lastExportMessage"
                                OnPlayPauseClick="@TogglePlayPause"
                                OnStopClick="@StopPlayback"
                                OnPreviousClick="@NavigatePrevious"
                                OnNextClick="@NavigateNext"
                                OnExportClick="@ExportCurrentSentence"/>
            }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer> 
