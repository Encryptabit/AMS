@page "/"

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4" @onkeydown="HandleKeyDown" tabindex="0">
    <MudGrid Spacing="2">

        @* Left Sidebar - Chapter List *@
        <MudItem xs="12" md="2">
            <MudPaper Elevation="2" Class="pa-3" Style="height: calc(100vh - 120px); overflow-y: auto;">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary">Workspace</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@WorkspaceDescription</MudText>

                    <MudTextField @bind-Value="_chapterFilter"
                                  Placeholder="Search chapters..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />

                    @if (_isChaptersLoading)
                    {
                        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                    }

                    <MudList T="string" Dense="true">
                        @if (FilteredChapters.Count == 0)
                        {
                            <MudListItem>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No chapters</MudText>
                            </MudListItem>
                        }
                        else
                        {
                            @foreach (var chapter in FilteredChapters)
                            {
                                <MudListItem OnClick="@(() => SelectChapterAsync(chapter))"
                                             Selected="@(chapter.Id == _selectedChapter?.Id)">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2">@chapter.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @FormatDuration(chapter.DurationSeconds) • @chapter.SentenceCount sentences
                                        </MudText>
                                    </MudStack>
                                </MudListItem>
                            }
                        }
                    </MudList>
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Center - Manuscript Panel *@
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-3" Style="height: calc(100vh - 120px); overflow-y: auto;">
                @if (_isChapterLoading)
                {
                    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%;">
                        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
                        <MudText Typo="Typo.subtitle1">Loading chapter…</MudText>
                    </MudStack>
                }
                else if (SelectedChapter is null)
                {
                    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%;">
                        <MudIcon Icon="@Icons.Material.Filled.LibraryMusic" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Select a chapter to begin</MudText>
                    </MudStack>
                }
                else
                {
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudText Typo="Typo.h5">@SelectedChapter.Name</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary">
                                @SelectedChapter.SentenceCount sentences
                            </MudChip>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                @FormatDuration(SelectedChapter.DurationSeconds)
                            </MudChip>
                        </MudStack>

                        <MudDivider />

                        <ManuscriptPanel Sentences="@SentencesToDisplay"
                                         SelectedSentence="@_selectedSentence"
                                         OnSentenceSelected="@OnSentenceSelected" />
                    </MudStack>
                }
            </MudPaper>
        </MudItem>

        @* Right Sidebar - Timecode Panel *@
        <MudItem xs="12" md="2">
            <MudPaper Elevation="2" Class="pa-3" Style="height: calc(100vh - 120px); overflow-y: auto;">
                <TimecodePanel Sentences="@SentencesToDisplay"
                               SelectedSentence="@_selectedSentence" />
            </MudPaper>
        </MudItem>

        @* Bottom - Audio Transport *@
        @if (SelectedChapter is not null)
        {
            <MudItem xs="12">
                <MudPaper Elevation="3" Class="pa-3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudTextField @bind-Value="_exportErrorCode"
                                          Label="Error Code"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Style="max-width: 150px;" />
                            <MudTextField @bind-Value="_exportComment"
                                          Label="Comment"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Class="flex-grow-1" />
                        </MudStack>

                        <AudioTransport @ref="_audioTransport"
                                        AudioSource="@AudioSource"
                                        CurrentTime="@_currentPlaybackTime"
                                        TotalTime="@SelectedChapter?.DurationSeconds"
                                        IsPlaying="@_isPlaying"
                                        CanNavigatePrevious="@CanNavigatePrevious"
                                        CanNavigateNext="@CanNavigateNext"
                                        CanExport="@(_selectedSentence?.Timing is not null && !_isExporting)"
                                        LastExportMessage="@_lastExportMessage"
                                        OnPlayPauseClick="@TogglePlayPause"
                                        OnStopClick="@StopPlayback"
                                        OnPreviousClick="@NavigatePrevious"
                                        OnNextClick="@NavigateNext"
                                        OnExportClick="@ExportCurrentSentence" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        }

    </MudGrid>
</MudContainer>
