@using Ams.Web.Dtos

<div class="manuscript-panel">
    @if (Sentences.Count == 0)
    {
        <div class="manuscript-empty">
            <MudText Typo="Typo.body1" Color="Color.Secondary">No sentences loaded</MudText>
        </div>
    }
    else
    {
        <MudVirtualize Items="@Sentences.ToList()" Context="sentence" OverscanCount="10">
            <div class="manuscript-row @GetRowClass(sentence)"
                 @onclick="@(() => OnSentenceClick(sentence))"
                 tabindex="0">

                <div class="manuscript-gutter-left">
                    <MudText Typo="Typo.caption" Class="sentence-id">S@sentence.Id</MudText>
                </div>

                <div class="manuscript-content">
                    <MudText Typo="Typo.body1" Class="sentence-text">
                        @sentence.BookText
                    </MudText>
                    @if (!string.IsNullOrEmpty(sentence.ScriptText) && sentence.ScriptText != sentence.BookText)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Warning" Class="script-text">
                            Script: @sentence.ScriptText
                        </MudText>
                    }
                </div>

                <div class="manuscript-gutter-right">
                    @if (sentence.Diff != null)
                    {
                        @if (sentence.Diff.Stats.Insertions > 0)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" Color="Color.Success" />
                        }
                        @if (sentence.Diff.Stats.Deletions > 0)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" Color="Color.Error" />
                        }
                    }
                </div>
            </div>
        </MudVirtualize>
    }
</div>

@code {
    [Parameter] public IReadOnlyList<SentenceDto> Sentences { get; set; } = Array.Empty<SentenceDto>();
    [Parameter] public SentenceDto? SelectedSentence { get; set; }
    [Parameter] public EventCallback<SentenceDto> OnSentenceSelected { get; set; }

    private string GetRowClass(SentenceDto sentence)
    {
        var classes = new List<string>();

        if (sentence == SelectedSentence)
        {
            classes.Add("selected");
        }

        if (sentence.Diff != null && (sentence.Diff.Stats.Insertions > 0 || sentence.Diff.Stats.Deletions > 0))
        {
            classes.Add("has-diff");
        }

        return string.Join(" ", classes);
    }

    private async Task OnSentenceClick(SentenceDto sentence)
    {
        await OnSentenceSelected.InvokeAsync(sentence);
    }
}
