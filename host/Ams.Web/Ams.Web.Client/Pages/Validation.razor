@page "/"
@page "/validation/{BookId?}"

@inherits ComponentBase
@implements IDisposable
@inject ValidationApiClient Api
@inject HttpClient Http
@inject NavigationManager Nav
@using Microsoft.AspNetCore.WebUtilities

<section class="viewer-shell">
    <aside class="viewer-sidebar">
        <div class="sidebar-header">
            <h3>Validation</h3>
            <p class="muted">Book: @EffectiveBookId</p>
        </div>

        @if (_loading)
        {
            <BitSpinnerLoading Size="BitSize.Large" Label="Loading"/>
        }
        else
        {
            <BitNav TItem="BitNavItem"
                    Items="@_navItems"
                    @bind-SelectedKey="_selectedKey"
                    OnSelect="OnNavSelect"/>
        }

        <div class="sidebar-footer">
            <BitButton OnClick="ResetReviews" Style="width:100%" Color="BitColor.Secondary" Variant="BitVariant.Outline"
                       IconName="ArrowReset">Reset reviews
            </BitButton>
        </div>
    </aside>

    <div class="viewer-main">
        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <BitMessage Color="BitColor.Error">@_error</BitMessage>
        }
        else if (_loading)
        {
            <div class="centered">
                <BitSpinnerLoading Size="BitSize.Large" Label="Loading"/>
            </div>
        }
        else if (_selectedKey == "overview" || _chapter is null)
        {
            @if (_overview is not null)
            {
                <h2>Overview</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Chapters</div>
                        <div class="stat-value">@_overview.ChapterCount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sentences</div>
                        <div class="stat-value">@_overview.TotalSentences</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Paragraphs</div>
                        <div class="stat-value">@_overview.TotalParagraphs</div>
                    </div>
                </div>

                <div class="chapter-cards">
                    @foreach (var chapter in _chapters)
                    {
                        var reviewed = IsReviewed(chapter.Id);
                        <div class="chapter-card" @onclick="() => NavigateToChapter(chapter.Id)">
                            <div class="chapter-title">@chapter.Id</div>
                            <div class="chapter-meta">Sentences: @chapter.SentenceCount •
                                Paragraphs: @chapter.ParagraphCount</div>
                            @if (reviewed)
                            {
                                <BitTag Color="BitColor.Success" Text="Reviewed"/>
                            }
                        </div>
                    }
                </div>
            }
        }
        else if (_chapter is not null)
        {
            <div class="chapter-header">
                <div>
                    <p class="eyebrow">Chapter</p>
                    <h2>@_chapter.ChapterId</h2>
                    <p class="muted">Sentences @_chapter.SentenceCount • Paragraphs @_chapter.ParagraphCount</p>
                </div>
                <BitToggleButton OnChange="ToggleReviewed" IsChecked="@IsReviewed(_chapter.ChapterId)"
                                 OffText="Mark reviewed" OnText="Reviewed" IconName="CheckMark"/>
            </div>

            <div class="badge-row">
                <BitTag Text="Raw" Color="@(_chapter.Audio.Raw ? BitColor.Primary : BitColor.Tertiary)"/>
                <BitTag Text="Treated" Color="@(_chapter.Audio.Treated ? BitColor.Primary : BitColor.Tertiary)"/>
                <BitTag Text="Filtered" Color="@(_chapter.Audio.Filtered ? BitColor.Primary : BitColor.Tertiary)"/>
            </div>

            @if (!string.IsNullOrEmpty(_audioVariant) && HasAudio(_audioVariant))
            {
                <div class="audio-row">
                    <div class="audio-variant-buttons">
                        @foreach (var variant in _availableVariants)
                        {
                            var selected = variant == _audioVariant;
                            <BitButton Color="@(selected ? BitColor.Primary : BitColor.Secondary)"
                                       Variant="BitVariant.Outline"
                                       OnClick="() => SetVariant(variant)">@variant</BitButton>
                        }
                    </div>
                    <WaveSurferPlayer AudioUrl="@BuildAudioUrl(_audioVariant)" Title="@($"Audio ({_audioVariant})")"/>
                </div>
            }

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Status</th>
                        <th>WER</th>
                        <th>Span WER</th>
                        <th>Text</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var sentence in _chapter.Sentences.Take(200))
                    {
                        var werClass = sentence.Metrics.Wer switch
                        {
                            > 5 => "high",
                            > 2 => "med",
                            _ => "low"
                        };
                        <tr>
                            <td>@sentence.Id</td>
                            <td>@sentence.Status</td>
                            <td><span class="wer @werClass">@sentence.Metrics.Wer.ToString("0.00")</span></td>
                            <td>@sentence.Metrics.SpanWer.ToString("0.00")</td>
                            <td>@sentence.BookText</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
    </div>
</section>

@code {
    [Parameter] public string? BookId { get; set; }

    private WorkspaceResponse? _workspace;
    private string EffectiveBookId => BookId
                                      ?? _workspace?.CurrentBookId
                                      ?? DeriveBookId(_workspace?.WorkspaceRoot)
                                      ?? string.Empty;

    private List<ValidationChapterSummaryDto> _chapters = new();
    private ValidationOverviewDto? _overview;
    private ReviewedStatusResponse _reviewed = new(new Dictionary<string, ReviewedStatusDto>(StringComparer.OrdinalIgnoreCase));
    private ChapterDetailDto? _chapter;
    private bool _loading = true;
    private string? _error;
    private string _selectedKey = "overview";
    private IList<BitNavItem> _navItems = new List<BitNavItem>();
    private string _audioVariant = string.Empty;
    private readonly string[] _variantPreference = ["treated", "raw", "filtered"];
    private IReadOnlyList<string> _availableVariants = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        Nav.LocationChanged += OnLocationChanged;
        await LoadAll();
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadAll()
    {
        _loading = true;
        _error = null;
        _chapters.Clear();
        StateHasChanged();

        try
        {
            _workspace = await Api.GetWorkspaceAsync();
            if (string.IsNullOrWhiteSpace(EffectiveBookId))
            {
                _error = "No book id provided and workspace has no current book. Use /validation/{bookId}.";
                _loading = false;
                StateHasChanged();
                return;
            }

            var overviewTask = Api.GetOverviewAsync(EffectiveBookId);
            var reviewedTask = Api.GetReviewedAsync(EffectiveBookId);

            ValidationOverviewDto? overviewFromApi = null;
            try
            {
                overviewFromApi = await overviewTask;
                _overview = overviewFromApi;
            }
            catch (Exception)
            {
                // Fall back to client-side aggregation if the overview endpoint fails (e.g., 404).
            }

            // Show whatever data we have so far.
            _loading = false;
            StateHasChanged();

            var totalSentences = 0;
            var totalParagraphs = 0;

            await foreach (var chapter in Api.StreamChaptersAsync(EffectiveBookId))
            {
                if (chapter is null) continue;
                _chapters.Add(chapter);
                totalSentences += chapter.SentenceCount;
                totalParagraphs += chapter.ParagraphCount;

                // If overview isn't available from API, synthesize it from streamed chapters.
                _overview ??= new ValidationOverviewDto(EffectiveBookId, 0, 0, 0);
                _overview = _overview with
                {
                    ChapterCount = _chapters.Count,
                    TotalSentences = totalSentences,
                    TotalParagraphs = totalParagraphs
                };

                // Refresh UI periodically while streaming.
                if (_chapters.Count % 5 == 0)
                {
                    StateHasChanged();
                }

                BuildNav();
            }

            // Ensure reviewed status is populated (for nav badges) after streaming finishes.
            _reviewed = await reviewedTask ?? new ReviewedStatusResponse(new Dictionary<string, ReviewedStatusDto>(StringComparer.OrdinalIgnoreCase));

            BuildNav();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            await TrySelectFromQuery();
            StateHasChanged();
        }
    }

    private void BuildNav()
    {
        var items = new List<BitNavItem>
        {
            new()
            {
                Key = "overview",
                Text = "Overview",
                IconName = "AreaChart"
            }
        };

        foreach (var chapter in _chapters)
        {
            items.Add(new BitNavItem
            {
                Key = chapter.Id,
                Text = chapter.Id,
                Url = BuildChapterUrl(chapter.Id),
                IconName = IsReviewed(chapter.Id) ? "CheckMark" : "Page",
                AriaLabel = $"{chapter.Id} ({chapter.SentenceCount} sentences)"
            });
        }

        _navItems = items;
    }

    private async Task OnNavSelect(BitNavItem item)
    {
        if (item.Key is null) return;

        if (item.Key == "overview")
        {
            _selectedKey = "overview";
            _chapter = null;
            Nav.NavigateTo(Nav.Uri.Split('?', 2)[0], false);
            StateHasChanged();
            return;
        }

        NavigateToChapter(item.Key);
    }

    private async Task SelectChapter(string chapterId)
    {
        _selectedKey = chapterId;
        _chapter = null;
        _error = null;
        StateHasChanged();

        try
        {
            _chapter = await Api.GetChapterDetailAsync(EffectiveBookId, chapterId);
            if (_chapter is not null)
            {
                _availableVariants = new[]
                {
                    _chapter.Audio.Treated ? "treated" : null,
                    _chapter.Audio.Raw ? "raw" : null,
                    _chapter.Audio.Filtered ? "filtered" : null
                }.Where(v => v is not null).Select(v => v!).ToArray();

                _audioVariant = _variantPreference.FirstOrDefault(v => HasAudio(v)) ?? _availableVariants.FirstOrDefault() ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        try
        {
            await TrySelectFromQuery();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool IsReviewed(string chapterId)
    {
        return _reviewed.Chapters.TryGetValue(chapterId, out var status) && status.Reviewed;
    }

    private async Task ToggleReviewed(bool isChecked)
    {
        if (_chapter is null) return;

        await Api.SetReviewedAsync(EffectiveBookId, _chapter.ChapterId, isChecked);
        _reviewed.Chapters[_chapter.ChapterId] = new ReviewedStatusDto(isChecked, DateTimeOffset.UtcNow.ToString("o"));
        BuildNav();
    }

    private async Task ResetReviews()
    {
        await Api.ResetReviewsAsync(EffectiveBookId);
        _reviewed = new ReviewedStatusResponse(new Dictionary<string, ReviewedStatusDto>(StringComparer.OrdinalIgnoreCase));
        BuildNav();
        StateHasChanged();
    }

    private async Task TrySelectFromQuery()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("chapter", out var value))
        {
            var chapterId = value.ToString();
            if (!string.IsNullOrWhiteSpace(chapterId) && _selectedKey != chapterId)
            {
                await SelectChapter(chapterId);
                _selectedKey = chapterId;
            }
        }
    }

    private void NavigateToChapter(string chapterId)
    {
        var url = BuildChapterUrl(chapterId);
        Nav.NavigateTo(url, false);
    }

    private string BuildChapterUrl(string chapterId)
    {
        return Nav.GetUriWithQueryParameter("chapter", chapterId);
    }

    private static string? DeriveBookId(string? path)
    {
        if (string.IsNullOrWhiteSpace(path)) return null;
        var trimmed = path.TrimEnd(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);
        var folder = trimmed.Split(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar).LastOrDefault();
        return string.IsNullOrWhiteSpace(folder) ? null : folder;
    }

    private bool HasAudio(string variant)
    {
        return variant switch
        {
            "raw" => _chapter?.Audio.Raw == true,
            "treated" => _chapter?.Audio.Treated == true,
            "filtered" => _chapter?.Audio.Filtered == true,
            _ => false
        };
    }

    private string BuildAudioUrl(string variant)
    {
        var baseUri = Http.BaseAddress?.ToString() ?? string.Empty;
        if (!baseUri.EndsWith('/')) baseUri += "/";
        return $"{baseUri}audio/books/{EffectiveBookId}/chapters/{_chapter?.ChapterId}?variant={variant}";
    }

    private void SetVariant(string variant)
    {
        if (HasAudio(variant))
        {
            _audioVariant = variant;
        }
    }

}
